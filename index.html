<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[rEd] Train Conductor Rotation - S749 (Shared)</title>
    <style>
        /* Basic Reset & Root Variables */
        :root {
            --bg-color-light: #f4f4f8;
            --text-color-light: #333;
            --card-bg-light: #fff;
            --border-color-light: #ddd;
            --primary-color-light: #007bff;
            --primary-text-light: #fff;
            --accent-color-light: #6c757d;
            --accent-text-light: #fff;
            --highlight-bg-light: #e9ecef;
            --input-bg-light: #fff;
            --input-border-light: #ccc;
            --button-hover-light: #0056b3;
            --remove-btn-light: #dc3545;
            --remove-btn-hover-light: #c82333;
            --skipped-bg-light: #fff3cd;
            --skipped-text-light: #856404;

            --bg-color-dark: #22272e;
            --text-color-dark: #c9d1d9;
            --card-bg-dark: #2d333b;
            --border-color-dark: #444c56;
            --primary-color-dark: #58a6ff;
            --primary-text-dark: #22272e;
            --accent-color-dark: #8b949e;
            --accent-text-dark: #22272e;
            --highlight-bg-dark: #373e47;
            --input-bg-dark: #22272e;
            --input-border-dark: #444c56;
            --button-hover-dark: #79b8ff;
            --remove-btn-dark: #f85149;
            --remove-btn-hover-dark: #da3633;
            --skipped-bg-dark: #3e3a2e;
            --skipped-text-dark: #d4a72c;

            /* Default to light mode variables */
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --primary-color: var(--primary-color-light);
            --primary-text: var(--primary-text-light);
            --accent-color: var(--accent-color-light);
            --accent-text: var(--accent-text-light);
            --highlight-bg: var(--highlight-bg-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --button-hover: var(--button-hover-light);
            --remove-btn: var(--remove-btn-light);
            --remove-btn-hover: var(--remove-btn-hover-light);
            --skipped-bg: var(--skipped-bg-light);
            --skipped-text: var(--skipped-text-light);
        }

        body.dark-mode {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
            --primary-color: var(--primary-color-dark);
            --primary-text: var(--primary-text-dark);
            --accent-color: var(--accent-color-dark);
            --accent-text: var(--accent-text-dark);
            --highlight-bg: var(--highlight-bg-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --button-hover: var(--button-hover-dark);
            --remove-btn: var(--remove-btn-dark);
            --remove-btn-hover: var(--remove-btn-hover-dark);
            --skipped-bg: var(--skipped-bg-dark);
            --skipped-text: var(--skipped-text-dark);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Layout */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
             font-size: 1.8em;
             color: var(--primary-color);
        }
        .controls-section, .member-section, .schedule-section, .skipped-section, .admin-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--bg-color); /* Slightly different bg for sections */
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.4em;
        }
        h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        /* Forms and Inputs */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            margin-right: 5px;
            margin-bottom: 5px; /* For wrapping */
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--primary-text);
        }
        .btn-primary:hover {
            background-color: var(--button-hover);
        }
        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        .btn-secondary:hover {
            opacity: 0.9;
        }
         .btn-remove {
            background-color: var(--remove-btn);
            color: var(--primary-text); /* White text usually works */
            font-size: 0.8em;
            padding: 3px 8px;
        }
        .btn-remove:hover {
            background-color: var(--remove-btn-hover);
        }
        .btn-vip-action {
             margin-top: 10px;
        }

        /* Lists */
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Ensure wrapping on small screens */
        }
        li:last-child {
            border-bottom: none;
        }
        li span {
             margin-right: 10px;
             word-break: break-word; /* Prevent long names breaking layout */
        }
        .rank-badge {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            color: var(--accent-text);
            background-color: var(--accent-color);
            white-space: nowrap;
        }
        .rank-R5 { background-color: #dc3545; }
        .rank-R4 { background-color: #ffc107; color: #333; }
        .rank-Member { background-color: #17a2b8; }

        /* Schedule Display */
        #schedule-display ul li {
            display: grid;
            grid-template-columns: 100px auto auto; /* Date | Conductor | VIP */
            gap: 10px;
            padding: 10px 5px;
            align-items: start;
        }
         #schedule-display ul li.current-day {
            background-color: var(--highlight-bg);
            font-weight: bold;
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
         }
        .schedule-date { font-weight: bold; }
        .schedule-conductor { }
        .schedule-vip { font-style: italic; }
        .mvp-selection-required {
            color: var(--remove-btn);
            font-weight: bold;
        }

        /* Current Day Section */
        #current-day-info {
            background-color: var(--highlight-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        #current-day-info p { margin-bottom: 8px; }
        #mvp-selection-area { display: none; margin-top: 10px; } /* Hidden by default */
        #mvp-selection-area label { margin-right: 10px; }

        /* Skipped VIPs */
        #skipped-vips ul li {
            background-color: var(--skipped-bg);
            color: var(--skipped-text);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
            justify-content: flex-start; /* Align name to the left */
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 15px;
            z-index: 100;
        }

        /* Admin Controls */
        .admin-section {
             margin-top: 20px;
             padding-top: 15px;
             border-top: 1px solid var(--border-color);
        }
         .admin-section button {
             margin-right: 10px;
         }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.2em; }
            button { font-size: 0.9em; padding: 8px 12px; }
            .theme-toggle { top: 5px; right: 5px; }

            #schedule-display ul li {
                grid-template-columns: 80px auto; /* Date | Conductor + VIP */
                gap: 5px;
                row-gap: 2px; /* Reduce space between rows when wrapped */
            }
            #schedule-display ul li > span:nth-child(2) { grid-column: 2; } /* Conductor */
            #schedule-display ul li > span:nth-child(3) { grid-column: 2; } /* VIP */

            li { flex-direction: column; align-items: flex-start; }
            li span { margin-bottom: 5px; }
            .member-actions { margin-top: 5px; } /* Space below name/rank */
        }
         @media (max-width: 480px) {
              h1 { font-size: 1.3em; }
              .header { margin-bottom: 15px; }
               #schedule-display ul li {
                  grid-template-columns: 65px auto; /* Smaller date column */
               }
               .schedule-date { font-size: 0.9em; }
         }

    </style>

    <!-- Firebase Libraries -->
    <!-- Using compatibility libraries for easier transition from v8 style -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

</head>
<body>

    <button id="theme-toggle" class="theme-toggle btn-secondary">Toggle Dark Mode</button>

    <div class="container">
        <header class="header">
            <h1>[rEd] Dead Redemption - Train Conductor Rotation</h1>
            <p>Server #749 (Shared)</p>
        </header>

        <!-- Current Day and Controls -->
        <section class="controls-section">
            <h2>Current Rotation Status</h2>
            <div id="current-day">
                <div id="current-day-info">
                    <p><strong>Date:</strong> <span id="current-date">Loading...</span></p>
                    <p><strong>Day:</strong> <span id="current-day-of-week">---</span></p>
                    <p><strong>Conductor:</strong> <span id="current-conductor">---</span></p>
                    <p><strong>Proposed VIP:</strong> <span id="current-vip">---</span></p>
                </div>

                <div id="mvp-selection-area">
                    <label for="mvp-select">Select Today's MVP Conductor:</label>
                    <select id="mvp-select">
                        <option value="">-- Select MVP --</option>
                    </select>
                </div>

                <div id="vip-actions">
                     <p>Did the proposed VIP accept?</p>
                     <button id="vip-accepted" class="btn-primary btn-vip-action">Yes, VIP Accepted</button>
                     <button id="vip-skipped" class="btn-secondary btn-vip-action">No, VIP Skipped</button>
                </div>
                 <div id="advance-controls" style="margin-top: 15px;">
                    <!-- Removed explicit advance button, actions trigger advance -->
                    <button id="undo-advance" class="btn-secondary">Undo Last Advancement</button>
                 </div>
            </div>
        </section>

        <!-- Skipped VIPs Queue -->
        <section class="skipped-section">
             <h2>Skipped VIP Queue (Priority)</h2>
             <div id="skipped-vips">
                 <p>Members who skipped will appear here and be offered VIP again first.</p>
                 <ul>
                     <!-- Skipped VIPs will be listed here -->
                 </ul>
             </div>
        </section>

        <!-- Rotation Schedule -->
        <section class="schedule-section">
             <h2>Upcoming Rotation Schedule</h2>
             <p>Showing the next full cycle of Members receiving VIP.</p>
             <div id="schedule-display">
                  <ul>
                      <!-- Schedule will be generated here -->
                  </ul>
             </div>
        </section>

        <!-- Member Management -->
        <section class="member-section">
            <h2>Manage Alliance Members</h2>
            <div id="member-manager">
                <h3>Add New Member</h3>
                <form id="add-member-form" class="form-group">
                    <label for="new-member-name">Name:</label>
                    <input type="text" id="new-member-name" required>
                    <label for="new-member-rank">Rank:</label>
                    <select id="new-member-rank">
                        <option value="Member">Member</option>
                        <option value="R4">R4</option>
                        <option value="R5">R5</option>
                    </select>
                    <button type="submit" class="btn-primary" style="margin-top: 10px;">Add Member</button>
                </form>

                <h3>Current Members (<span id="member-count">0</span>)</h3>
                <ul id="member-list">
                    <!-- Member list will be populated here -->
                </ul>
            </div>
        </section>

        <!-- Admin Controls -->
        <section class="admin-section">
            <h2>Admin</h2>
            <p>Use reset only if absolutely necessary. It affects everyone.</p>
            <button id="reset-data" class="btn-remove">Reset All Data to Defaults</button>
        </section>

    </div>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace placeholders with your actual Firebase project config!
        const firebaseConfig = {
  apiKey: "AIzaSyAT8L9vDqFHyGB-MybtcLEBgCALuNflTZY",
  authDomain: "red-train-rotation-tool.firebaseapp.com",
  projectId: "red-train-rotation-tool",
  storageBucket: "red-train-rotation-tool.firebasestorage.app",
  messagingSenderId: "178389819926",
  appId: "1:178389819926:web:bd59c273641ab8530ccb37"
};

        // --- Initialize Firebase (using Compat libraries) ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Get Firestore instance

        // --- Firestore Document Reference ---
        // Stores the entire state in one document for simplicity.
        // Ensure Firestore rules allow access to this path.
        const stateDocRef = db.collection("rotationState").doc("s749_state");

        // --- Constants and State ---
        const MVP_TECH_DAY = 1; // Monday
        const MVP_VS_DAY = 0;   // Sunday

        // Local state object - This will be overwritten by Firestore data on load/update
        let state = {
            members: [],
            rotationState: {
                currentDate: null, // ISO String YYYY-MM-DD
                r4r5Index: 0,
                memberIndex: 0,
                skippedVips: [], // Array of member IDs
                selectedMvps: {}, // Key: "YYYY-MM-DD_Sun" or "YYYY-MM-DD_Mon", Value: memberId
            },
            // previousRotationState is managed *only* locally in browser memory for undo
            previousRotationState: null
        };

        // --- Initial Data (Only used if Firestore is empty on first load) ---
         const initialMembers = [
            { name: "Motherfrogger", rank: "R5"}, { name: "Enyaisrave", rank: "R4"}, { name: "Johcar", rank: "R4"},
            { name: "DaVinnie", rank: "R4"}, { name: "CornFlakes", rank: "R4"}, { name: "Lyfe", rank: "R4"},
            { name: "LadyLaik", rank: "R4"}, { name: "Pabs64", rank: "R4"}, { name: "Supersebb", rank: "R4"},
            { name: "Munky", rank: "R4"}, { name: "NymbleV", rank: "R4"}, { name: "R1/R2/R3 Team", rank: "Member"},
            { name: "Smugwell", rank: "Member"}, { name: "MRAN", rank: "Member"}, { name: "Chris", rank: "Member"},
            { name: "Leka98", rank: "Member"}, { name: "Darkknight", rank: "Member"}, { name: "Rikkyyyyy", rank: "Member"},
            { name: "Gekkegerrittttt", rank: "Member"}, { name: "Ever4", rank: "Member"}, { name: "KFCPov3r", rank: "Member"},
            { name: "F L A C", rank: "Member"}, { name: "Jotersan", rank: "Member"}, { name: "Novis01", rank: "Member"},
            { name: "Gorkiules", rank: "Member"}, { name: "Jaista", rank: "Member"}, { name: "Megalomanie", rank: "Member"},
            { name: "АЛЕКС1980", rank: "Member"}, { name: "TheFloh", rank: "Member"}, { name: "Caretta", rank: "Member"},
            { name: "Swisskilla", rank: "Member"}, { name: "Llama deDrama", rank: "Member"}, { name: "oo APACHE oo", rank: "Member"},
            { name: "GoFireES", rank: "Member"}, { name: "Foggis", rank: "Member"}, { name: "Paracitus", rank: "Member"},
            { name: "IRONHAMMER", rank: "Member"}, { name: "jarako", rank: "Member"}, { name: "Be a wolf", rank: "Member"},
            { name: "Commander Blad", rank: "Member"}, { name: "ILYES B", rank: "Member"}, { name: "KingStridez", rank: "Member"},
            { name: "diRty freNk", rank: "Member"}, { name: "PavlosP", rank: "Member"}, { name: "Chasseur 777", rank: "Member"},
            { name: "Raph911", rank: "Member"}, { name: "B1wizz", rank: "Member"}, { name: "Thirteen Squid", rank: "Member"},
            { name: "ЖЭКА", rank: "Member"}, { name: "SkyWinder", rank: "Member"}, { name: "FireXice (Bibot)", rank: "Member"},
            { name: "GhósT", rank: "Member"}, { name: "Juantxo79", rank: "Member"}, { name: "Kezual", rank: "Member"},
            { name: "Maytos", rank: "Member"}, { name: "jassådu", rank: "Member"}, { name: "Temd", rank: "Member"},
            { name: "olabaf", rank: "Member"}, { name: "Faluche", rank: "Member"}, { name: "xPerseus", rank: "Member"},
            { name: "Lutonian", rank: "Member"}, { name: "Juggernaut x", rank: "Member"}, { name: "Umbra XIII", rank: "Member"},
            { name: "BLÀDE", rank: "Member"}, { name: "koppies", rank: "Member"}, { name: "Cocsi29400", rank: "Member"},
            { name: "Nohardfeelz", rank: "Member"}, { name: "Vechniy", rank: "Member"}, { name: "theFoxXx", rank: "Member"},
            { name: "S A M U R A i", rank: "Member"}, { name: "Dfyra", rank: "Member"}, { name: "Meloziaa", rank: "Member"},
            { name: "Aminos77", rank: "Member"}, { name: "Rev T", rank: "Member"}, { name: "BlackWizardUA", rank: "Member"},
            { name: "Bekim1", rank: "Member"}, { name: "Edx777", rank: "Member"}, { name: "Laeta", rank: "Member"},
            { name: "Kyuchie", rank: "Member"}, { name: "depechefann", rank: "Member"}, { name: "BlackPush", rank: "Member"},
            { name: "Gunnovic", rank: "Member"}, { name: "NinoDelBono", rank: "Member"}, { name: "Dario217", rank: "Member"}
        ].map(m => ({ ...m, id: generateId() })); // Add unique IDs

        // --- DOM Elements ---
        const memberListEl = document.getElementById('member-list');
        const addMemberForm = document.getElementById('add-member-form');
        const newMemberNameInput = document.getElementById('new-member-name');
        const newMemberRankSelect = document.getElementById('new-member-rank');
        const memberCountEl = document.getElementById('member-count');
        const currentDateEl = document.getElementById('current-date');
        const currentDayOfWeekEl = document.getElementById('current-day-of-week');
        const currentConductorEl = document.getElementById('current-conductor');
        const currentVipEl = document.getElementById('current-vip');
        const skippedVipsListEl = document.getElementById('skipped-vips').querySelector('ul');
        const scheduleDisplayListEl = document.getElementById('schedule-display').querySelector('ul');
        const vipAcceptedBtn = document.getElementById('vip-accepted');
        const vipSkippedBtn = document.getElementById('vip-skipped');
        // const advanceDayBtn = document.getElementById('advance-day'); // Removed
        const undoAdvanceBtn = document.getElementById('undo-advance');
        const mvpSelectionArea = document.getElementById('mvp-selection-area');
        const mvpSelect = document.getElementById('mvp-select');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const resetBtn = document.getElementById('reset-data');
        // Removed export/import buttons and related elements

        // --- Utility Functions ---
        function generateId() {
            // Simple ID generator
            return Math.random().toString(36).substring(2, 15);
        }

        function getDayOfWeek(date) { // 0 = Sunday, 1 = Monday, ...
            return date.getDay();
        }

        function formatDate(date) {
             // Ensure date is a Date object
             if (!(date instanceof Date) || isNaN(date)) {
                  return "Invalid Date"; // Handle potential errors
             }
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getISODateString(date) {
             // Ensure date is a Date object
             if (!(date instanceof Date) || isNaN(date)) {
                 console.error("getISODateString received invalid date:", date);
                 // Return today's date as a fallback, or handle error appropriately
                 return new Date().toISOString().split('T')[0];
             }
            return date.toISOString().split('T')[0];
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function findNextMonday(date) {
            const currentDay = getDayOfWeek(date);
            // If today is Monday (1), add 7 days. If Sunday (0), add 1 day. etc.
            const daysUntilMonday = (8 - currentDay) % 7;
            // Handle case where today *is* Monday, start *next* Monday
            const daysToAdd = daysUntilMonday === 0 ? 7 : daysUntilMonday;
            return addDays(date, daysToAdd);
        }

        function getMemberById(id) {
             // Ensure state.members is an array before searching
             if (!Array.isArray(state.members)) {
                 console.error("state.members is not an array in getMemberById");
                 return null;
             }
            return state.members.find(m => m.id === id);
        }

        function getMembersByRank(rank) {
             // Ensure state.members is an array before filtering
             if (!Array.isArray(state.members)) {
                 console.error("state.members is not an array in getMembersByRank");
                 return [];
             }
             if (rank === 'R4/R5') {
                return state.members.filter(m => m.rank === 'R4' || m.rank === 'R5');
             }
            return state.members.filter(m => m.rank === rank);
        }

        // --- Core Logic Functions (Mostly Unchanged) ---
        function calculateDailyAssignments(targetDateStr, currentR4R5Index, currentMemberIndex, currentSkippedVips, selectedMvpsMap) {
            // Ensure parameters are valid before proceeding
             if (!targetDateStr || typeof currentR4R5Index !== 'number' || typeof currentMemberIndex !== 'number' || !Array.isArray(currentSkippedVips) || typeof selectedMvpsMap !== 'object') {
                console.error("Invalid parameters passed to calculateDailyAssignments", {targetDateStr, currentR4R5Index, currentMemberIndex, currentSkippedVips, selectedMvpsMap});
                return { date: new Date(), conductor: { id: 'ERROR_PARAMS', name: 'Invalid Input Error', rank: 'System' }, vip: { id: 'ERROR_PARAMS', name: 'Invalid Input Error', rank: 'System' } };
             }

            const targetDate = new Date(targetDateStr + 'T00:00:00Z'); // Use UTC
             if (isNaN(targetDate)) { // Check if date parsing failed
                 console.error("Invalid date string for calculation:", targetDateStr);
                 return { date: new Date(), conductor: { id: 'ERROR_DATE', name: 'Invalid Date Error', rank: 'System' }, vip: { id: 'ERROR_DATE', name: 'Invalid Date Error', rank: 'System' } };
             }

            const dayOfWeek = getDayOfWeek(targetDate);

            let conductor = null;
            let vip = null;

            const r4r5Members = getMembersByRank('R4/R5');
            const memberMembers = getMembersByRank('Member');

            // Determine Conductor
            if (dayOfWeek === MVP_TECH_DAY) { // Monday
                 const mvpKey = `${targetDateStr}_Mon`;
                 const selectedMvpId = selectedMvpsMap[mvpKey];
                 conductor = selectedMvpId ? getMemberById(selectedMvpId) : { id: 'MVP_MON_SELECT', name: 'Tech MVP Selection Required', rank: 'MVP' };
            } else if (dayOfWeek === MVP_VS_DAY) { // Sunday
                 const mvpKey = `${targetDateStr}_Sun`;
                 const selectedMvpId = selectedMvpsMap[mvpKey];
                 conductor = selectedMvpId ? getMemberById(selectedMvpId) : { id: 'MVP_SUN_SELECT', name: 'VS MVP Selection Required', rank: 'MVP' };
            } else { // Tuesday - Saturday
                if (r4r5Members.length > 0) {
                    const conductorIndex = currentR4R5Index % r4r5Members.length;
                    conductor = r4r5Members[conductorIndex];
                } else {
                    conductor = { id: 'NO_R4R5', name: 'No R4/R5 Available', rank: 'System' };
                }
            }

            // Determine VIP (Member)
            if (memberMembers.length > 0) {
                const validSkippedVips = currentSkippedVips.filter(id => getMemberById(id)); // Filter out removed members
                if (validSkippedVips.length > 0) {
                    vip = getMemberById(validSkippedVips[0]); // Offer to the first valid skipped VIP
                } else {
                    const vipIndex = currentMemberIndex % memberMembers.length;
                    vip = memberMembers[vipIndex];
                     // Reset skipped list in state if it only contained invalid IDs
                     if (validSkippedVips.length !== currentSkippedVips.length) {
                         state.rotationState.skippedVips = []; // Clear out invalid IDs (will be saved on next update)
                         console.warn("Cleared invalid IDs from skipped VIP list.");
                     }
                }
            } else {
                vip = { id: 'NO_MEMBERS', name: 'No Members Available', rank: 'System' };
            }

            // Ensure VIP and Conductor objects are returned, even if defaults/errors
            conductor = conductor || { id: 'ERROR_CONDUCTOR', name: 'Error Assigning Conductor', rank: 'System' };
            vip = vip || { id: 'ERROR_VIP', name: 'Error Assigning VIP', rank: 'System' };

            return { date: targetDate, conductor, vip };
        }

        function advanceRotation(vipAccepted, selectedMvpId = null) {
            // This function now modifies the *local* state object directly.
            // It does *not* call save/update functions. That happens *after* this runs.

            if (!state.rotationState || !state.rotationState.currentDate) {
                 console.error("Cannot advance rotation: state or currentDate is missing.");
                 return; // Should not happen if listener works, but safety check
             }

            // Get current state details from the local 'state' object
            const currentDate = new Date(state.rotationState.currentDate + 'T00:00:00Z');
            const currentDayOfWeek = getDayOfWeek(currentDate);
            const currentR4R5Index = state.rotationState.r4r5Index;
            const currentMemberIndex = state.rotationState.memberIndex;
            const currentSkippedVips = [...state.rotationState.skippedVips]; // Copy

            // Determine the VIP who was proposed for the *current* day
            const { vip: proposedVip } = calculateDailyAssignments(
                state.rotationState.currentDate,
                currentR4R5Index,
                currentMemberIndex,
                currentSkippedVips,
                state.rotationState.selectedMvps
            );

            if (!proposedVip || !proposedVip.id || proposedVip.id.startsWith('NO_') || proposedVip.id.startsWith('ERROR_')) {
                 console.warn("Cannot advance: No valid VIP proposed for today. Check Member list.");
                 alert("Cannot advance: No valid VIP was proposed for today. Check Member list.");
                 // Don't modify state if advance failed
                 return;
            }

            // Update indices and skipped list based on VIP action
            let nextR4R5Index = currentR4R5Index;
            let nextMemberIndex = currentMemberIndex;
            let nextSkippedVips = [...currentSkippedVips]; // Work on a fresh copy

            const wasVipFromSkippedList = nextSkippedVips.length > 0 && nextSkippedVips[0] === proposedVip.id;

            if (vipAccepted) {
                if (wasVipFromSkippedList) {
                    nextSkippedVips.shift(); // Remove accepted VIP from skipped list
                } else {
                    nextMemberIndex = (currentMemberIndex + 1); // Advance regular index
                }
            } else { // VIP Skipped
                if (!wasVipFromSkippedList) {
                    // Add to *front* of skipped list only if not already there
                     if (!nextSkippedVips.includes(proposedVip.id)) {
                         nextSkippedVips.unshift(proposedVip.id);
                     }
                    // Member index does NOT advance
                }
                // If already skipped & skipped again, stays at front. No change needed here.
            }

            // Advance R4/R5 index ONLY if transitioning from a Tue-Sat day
            if (currentDayOfWeek >= 2 && currentDayOfWeek <= 6) {
                nextR4R5Index = (currentR4R5Index + 1);
            }

             // Store selected MVP if provided for today
             if (selectedMvpId) {
                 if (currentDayOfWeek === MVP_TECH_DAY) {
                     state.rotationState.selectedMvps[`${state.rotationState.currentDate}_Mon`] = selectedMvpId;
                 } else if (currentDayOfWeek === MVP_VS_DAY) {
                     state.rotationState.selectedMvps[`${state.rotationState.currentDate}_Sun`] = selectedMvpId;
                 }
             }

            // Calculate next date
            const nextDate = addDays(currentDate, 1);
            const nextDateStr = getISODateString(nextDate);

            // Update the local state object directly
            state.rotationState.currentDate = nextDateStr;
            state.rotationState.r4r5Index = nextR4R5Index;
            state.rotationState.memberIndex = nextMemberIndex;
            state.rotationState.skippedVips = nextSkippedVips;
            // selectedMvps was updated above if necessary

            console.log("Local state advanced:", state.rotationState);
            // The calling function (handleVipAction) will handle saving to Firestore
        }

        // --- Firestore Persistence ---
        function updateFirestoreState() {
            // Prepare the state object to save (exclude local-only previousRotationState)
            const stateToSave = {
                 members: state.members || [], // Ensure array
                 rotationState: {
                      currentDate: state.rotationState.currentDate,
                      r4r5Index: state.rotationState.r4r5Index ?? 0,
                      memberIndex: state.rotationState.memberIndex ?? 0,
                      skippedVips: state.rotationState.skippedVips || [], // Ensure array
                      selectedMvps: state.rotationState.selectedMvps || {}, // Ensure object
                 }
            };

            console.log("Attempting to write to Firestore:", stateToSave);
            stateDocRef.set(stateToSave)
                .then(() => {
                    console.log("State successfully written to Firestore!");
                })
                .catch((error) => {
                    console.error("Error writing state to Firestore: ", error);
                    alert(`Error saving changes: ${error.message}. Please check console or try again later.`);
                });
        }

        // --- Member Management Functions ---
        function addMember(event) {
            event.preventDefault();
            const name = newMemberNameInput.value.trim();
            const rank = newMemberRankSelect.value;

            if (name && rank) {
                if (!Array.isArray(state.members)) state.members = []; // Ensure array exists

                if (state.members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                     alert(`Member "${name}" already exists.`);
                     return;
                 }

                const newMember = {
                    id: generateId(), // Generate unique ID
                    name: name,
                    rank: rank
                };
                state.members.push(newMember);
                sortMembers(); // Sort the local state
                updateFirestoreState(); // Push the updated state to Firestore
                // UI update will be triggered by the Firestore listener
                newMemberNameInput.value = ''; // Clear form
            } else {
                alert("Please enter both name and rank.");
            }
        }

        function removeMember(idToRemove) {
            const memberToRemove = getMemberById(idToRemove);
            if (!memberToRemove) return;

             if (confirm(`Are you sure you want to remove ${memberToRemove.name}? This will update for everyone.`)) {
                if (!Array.isArray(state.members)) state.members = [];
                state.members = state.members.filter(member => member.id !== idToRemove);

                // Also remove from skipped list if present
                if (!Array.isArray(state.rotationState.skippedVips)) state.rotationState.skippedVips = [];
                state.rotationState.skippedVips = state.rotationState.skippedVips.filter(id => id !== idToRemove);

                // Also remove from selected MVPs history
                 if (typeof state.rotationState.selectedMvps !== 'object') state.rotationState.selectedMvps = {};
                 for (const key in state.rotationState.selectedMvps) {
                     if (state.rotationState.selectedMvps[key] === idToRemove) {
                         delete state.rotationState.selectedMvps[key];
                     }
                 }

                // Update Firestore with the modified state
                updateFirestoreState();
                // UI update will be triggered by the Firestore listener
             }
        }

        function sortMembers() {
             if (!Array.isArray(state.members)) return; // Don't sort if not an array
            const rankOrder = { 'R5': 1, 'R4': 2, 'Member': 3 };
            state.members.sort((a, b) => {
                 const rankDiff = (rankOrder[a.rank] || 99) - (rankOrder[b.rank] || 99); // Handle potential undefined ranks
                 if (rankDiff !== 0) return rankDiff;
                 // Optional: Sort by name within the same rank for consistency
                 return (a.name || "").localeCompare(b.name || "");
            });
        }


        // --- Rendering Functions ---
        function renderMemberList() {
            memberListEl.innerHTML = ''; // Clear existing list
            if (!Array.isArray(state.members)) {
                 memberListEl.innerHTML = '<li>Error loading members.</li>';
                 memberCountEl.textContent = 'Error';
                 return;
             }

            memberCountEl.textContent = state.members.length;
            sortMembers(); // Ensure sorted before rendering

            if (state.members.length === 0) {
                memberListEl.innerHTML = '<li>No members added yet.</li>';
                return;
            }

            state.members.forEach(member => {
                 if (!member || !member.id || !member.name || !member.rank) return; // Skip invalid member entries

                const li = document.createElement('li');
                li.dataset.memberId = member.id;

                const memberInfo = document.createElement('span');
                memberInfo.textContent = member.name;

                const rankBadge = document.createElement('span');
                rankBadge.classList.add('rank-badge', `rank-${member.rank}`);
                rankBadge.textContent = member.rank;
                memberInfo.appendChild(rankBadge);

                const actions = document.createElement('div');
                actions.classList.add('member-actions');

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.classList.add('btn-remove');
                removeBtn.onclick = () => removeMember(member.id);

                actions.appendChild(removeBtn);
                li.appendChild(memberInfo);
                li.appendChild(actions);
                memberListEl.appendChild(li);
            });
        }

        function renderCurrentDay() {
            if (!state.rotationState || !state.rotationState.currentDate) {
                currentDateEl.textContent = "Not Initialized";
                currentDayOfWeekEl.textContent = "---";
                currentConductorEl.textContent = "---";
                currentVipEl.textContent = "---";
                document.getElementById('vip-actions').style.display = 'none';
                mvpSelectionArea.style.display = 'none';
                undoAdvanceBtn.disabled = true;
                return;
            }

            const currentDate = new Date(state.rotationState.currentDate + 'T00:00:00Z');
             if (isNaN(currentDate)) {
                 currentDateEl.textContent = "Invalid Date!";
                 return; // Stop rendering if date is bad
             }

            const dayOfWeek = getDayOfWeek(currentDate);

            const { conductor, vip } = calculateDailyAssignments(
                state.rotationState.currentDate,
                state.rotationState.r4r5Index,
                state.rotationState.memberIndex,
                state.rotationState.skippedVips,
                state.rotationState.selectedMvps
            );

             // Check if calculation resulted in errors
             if (!conductor || !vip || conductor.id?.startsWith('ERROR_') || vip.id?.startsWith('ERROR_')) {
                  currentDateEl.textContent = formatDate(currentDate);
                  currentDayOfWeekEl.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                  currentConductorEl.textContent = "Error calculating assignments";
                  currentVipEl.textContent = "Error calculating assignments";
                  document.getElementById('vip-actions').style.display = 'none';
                  mvpSelectionArea.style.display = 'none';
                   undoAdvanceBtn.disabled = true;
                  return;
             }


            currentDateEl.textContent = formatDate(currentDate);
            currentDayOfWeekEl.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });

            let isMvpSelectionNeeded = false;
            const conductorName = conductor.name || "Unknown Conductor";
            const conductorRank = conductor.rank || "N/A";

            if (conductor.id === 'MVP_MON_SELECT' || conductor.id === 'MVP_SUN_SELECT') {
                 currentConductorEl.innerHTML = `<span class="mvp-selection-required">${conductorName}</span>`;
                 isMvpSelectionNeeded = true;
                 populateMvpSelect();
                 mvpSelectionArea.style.display = 'block';
                 mvpSelect.value = ""; // Reset selection
            } else {
                currentConductorEl.textContent = `${conductorName} (${conductorRank})`;
                mvpSelectionArea.style.display = 'none';
            }

             const vipName = vip.name || "Unknown VIP";
             const vipRank = vip.rank || "N/A";
            let isVipActionPossible = false;

            if (vip.id === 'NO_MEMBERS' || vip.id === 'ERROR_VIP') {
                currentVipEl.textContent = vipName;
                document.getElementById('vip-actions').style.display = 'none';
            } else {
                currentVipEl.textContent = `${vipName} (${vipRank})`;
                document.getElementById('vip-actions').style.display = 'block';
                 isVipActionPossible = true;
            }

            // Enable/Disable VIP action buttons based on MVP requirement
             vipAcceptedBtn.disabled = isMvpSelectionNeeded;
             vipSkippedBtn.disabled = isMvpSelectionNeeded;

            // Update Undo button state based on local memory
            undoAdvanceBtn.disabled = !state.previousRotationState;
        }


        function populateMvpSelect() {
            mvpSelect.innerHTML = '<option value="">-- Select MVP --</option>';
             if (!Array.isArray(state.members)) return; // Safety check

            state.members.forEach(member => {
                if (!member || !member.id) return; // Skip invalid members
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.rank})`;
                mvpSelect.appendChild(option);
            });
        }

        function renderSkippedVips() {
            skippedVipsListEl.innerHTML = '';
            if (!state.rotationState || !Array.isArray(state.rotationState.skippedVips)) {
                skippedVipsListEl.innerHTML = '<li>Error loading skipped list.</li>';
                return;
            }

            if (state.rotationState.skippedVips.length === 0) {
                skippedVipsListEl.innerHTML = '<li>Queue is empty.</li>';
                return;
            }

            state.rotationState.skippedVips.forEach(memberId => {
                const member = getMemberById(memberId);
                if (member) {
                    const li = document.createElement('li');
                    li.textContent = `${member.name} (${member.rank})`;
                    skippedVipsListEl.appendChild(li);
                } else {
                     // Member might have been removed, show placeholder
                     const li = document.createElement('li');
                     li.textContent = `Removed Member (ID: ${memberId})`;
                     li.style.fontStyle = 'italic';
                     li.style.color = 'grey';
                     skippedVipsListEl.appendChild(li);
                }
            });
        }

        function renderSchedule() {
             scheduleDisplayListEl.innerHTML = ''; // Clear existing schedule
             if (!state.rotationState || !state.rotationState.currentDate || !Array.isArray(state.members)) {
                 scheduleDisplayListEl.innerHTML = '<li>Rotation not ready or no members.</li>';
                 return;
             }

             const memberMembers = getMembersByRank('Member');
             if (memberMembers.length === 0) {
                 scheduleDisplayListEl.innerHTML = '<li>No "Member" rank players available for VIP rotation.</li>';
                 return;
             }

             // Filter skipped VIPs to only include valid, existing members
             const validSkippedVips = (state.rotationState.skippedVips || []).filter(id => getMemberById(id));
             const scheduleLength = memberMembers.length + validSkippedVips.length; // Show one full cycle

             let tempDate = new Date(state.rotationState.currentDate + 'T00:00:00Z');
             let tempR4R5Index = state.rotationState.r4r5Index ?? 0;
             let tempMemberIndex = state.rotationState.memberIndex ?? 0;
             let tempSkippedVips = [...validSkippedVips]; // Use filtered list for projection
             let tempSelectedMvps = JSON.parse(JSON.stringify(state.rotationState.selectedMvps || {}));

             for (let i = 0; i < Math.max(1, scheduleLength); i++) { // Ensure at least one day is shown
                 const dateStr = getISODateString(tempDate);
                 if (!dateStr) continue; // Skip if date is invalid

                 const dayOfWeek = getDayOfWeek(tempDate);

                 // Use calculate function with temporary state copies
                 const { conductor, vip } = calculateDailyAssignments(
                     dateStr,
                     tempR4R5Index,
                     tempMemberIndex,
                     tempSkippedVips,
                     tempSelectedMvps
                 );

                  // Check for calculation errors
                 if (conductor.id?.startsWith('ERROR_') || vip.id?.startsWith('ERROR_')) {
                      console.warn(`Schedule calculation error on ${dateStr}`);
                      // Optionally display an error in the schedule list
                      const errLi = document.createElement('li');
                      errLi.textContent = `${formatDate(tempDate)} - Error calculating`;
                      errLi.style.color = 'red';
                      scheduleDisplayListEl.appendChild(errLi);
                      // Advance date and continue loop
                      tempDate = addDays(tempDate, 1);
                      continue;
                 }


                 const li = document.createElement('li');
                 if (i === 0) {
                     li.classList.add('current-day');
                 }

                 const dateSpan = document.createElement('span');
                 dateSpan.classList.add('schedule-date');
                 dateSpan.textContent = formatDate(tempDate);

                 const conductorSpan = document.createElement('span');
                 conductorSpan.classList.add('schedule-conductor');
                 const conductorName = conductor.name || "Unknown Conductor";
                 const conductorRank = conductor.rank || "N/A";
                 if (conductor.id === 'MVP_MON_SELECT' || conductor.id === 'MVP_SUN_SELECT') {
                      conductorSpan.innerHTML = `<span class="mvp-selection-required">${conductorName}</span>`;
                 } else {
                     conductorSpan.textContent = `C: ${conductorName} (${conductorRank})`;
                 }

                 const vipSpan = document.createElement('span');
                 vipSpan.classList.add('schedule-vip');
                 const vipName = vip.name || "Unknown VIP";
                 const vipRank = vip.rank || "N/A";
                 if (vip.id === 'NO_MEMBERS' || vip.id === 'ERROR_VIP') {
                     vipSpan.textContent = vipName;
                 } else {
                      vipSpan.textContent = `VIP: ${vipName} (${vipRank})`;
                      if (tempSkippedVips.length > 0 && tempSkippedVips[0] === vip.id) {
                           vipSpan.textContent += ' (Skipped)';
                      }
                 }

                 li.appendChild(dateSpan);
                 li.appendChild(conductorSpan);
                 li.appendChild(vipSpan);
                 scheduleDisplayListEl.appendChild(li);

                 // Simulate advancement for the *next* day's calculation (assuming acceptance)
                 const wasVipFromSkippedList = tempSkippedVips.length > 0 && tempSkippedVips[0] === vip?.id;

                 if (wasVipFromSkippedList) {
                     tempSkippedVips.shift();
                 } else if (vip.id && !vip.id.startsWith('NO_') && !vip.id.startsWith('ERROR_')) {
                     tempMemberIndex = (tempMemberIndex + 1);
                 }

                 if (dayOfWeek >= 2 && dayOfWeek <= 6) { // If *current* day was Tue-Sat
                     tempR4R5Index = (tempR4R5Index + 1);
                 }

                 // Advance to the next day
                 tempDate = addDays(tempDate, 1);
             }
        }

        function render() {
            console.log("Rendering UI with current local state:", JSON.parse(JSON.stringify(state))); // Deep copy for logging

            // Apply theme (remains local)
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = "Toggle Light Mode";
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = "Toggle Dark Mode";
            }

            renderMemberList();     // Depends on state.members
            renderSkippedVips();    // Depends on state.rotationState.skippedVips and state.members
            renderCurrentDay();     // Depends on state.rotationState and state.members
            renderSchedule();       // Depends on state.rotationState and state.members

             // Ensure undo button state reflects local memory
             undoAdvanceBtn.disabled = !state.previousRotationState;
        }

        // --- Event Listeners ---
        addMemberForm.addEventListener('submit', addMember);

        vipAcceptedBtn.addEventListener('click', () => handleVipAction(true));
        vipSkippedBtn.addEventListener('click', () => handleVipAction(false));

        function handleVipAction(accepted) {
            if (!state.rotationState || !state.rotationState.currentDate) {
                 alert("Rotation state not loaded yet. Please wait.");
                 return;
             }

            const currentDateStr = state.rotationState.currentDate;
            const currentDate = new Date(currentDateStr + 'T00:00:00Z');
            const dayOfWeek = getDayOfWeek(currentDate);
            let selectedMvpId = null;

            // Check if MVP selection is required *and* not yet made for today
            if (dayOfWeek === MVP_TECH_DAY || dayOfWeek === MVP_VS_DAY) {
                 const mvpKey = dayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`;
                 // Only require selection if it's not already recorded in the state for this day
                 if (!state.rotationState.selectedMvps[mvpKey]) {
                     selectedMvpId = mvpSelect.value;
                     if (!selectedMvpId) {
                         alert("Please select the MVP Conductor for today using the dropdown.");
                         return; // Stop processing if MVP needed but not selected
                     }
                 }
            }

            // Store the CURRENT state locally for potential UNDO *before* advancing
            // Deep copy is essential here
            state.previousRotationState = JSON.parse(JSON.stringify(state.rotationState));
            console.log("Stored previous state for undo:", state.previousRotationState);


            // Advance the local state (this function modifies 'state' directly)
            advanceRotation(accepted, selectedMvpId);

            // Push the *new* state to Firestore
            updateFirestoreState();

            // The UI will re-render automatically via the Firestore listener.
            // Manually update the undo button's enabled state *immediately*
             undoAdvanceBtn.disabled = !state.previousRotationState;
        }

        undoAdvanceBtn.addEventListener('click', () => {
            if (!state.previousRotationState) {
                alert("No previous state to undo.");
                return;
            }
            if (confirm("Are you sure you want to undo the last advancement? This will revert the date, indices, and skipped list for everyone.")) {
                // Restore the rotation part of the state from the local backup
                 state.rotationState = JSON.parse(JSON.stringify(state.previousRotationState));
                 // Clear the local undo buffer
                 state.previousRotationState = null;
                 console.log("Rolled back local state:", state.rotationState);


                 // Push the rolled-back state to Firestore
                 updateFirestoreState();

                 // The UI will update via the listener. Disable undo button locally immediately.
                 undoAdvanceBtn.disabled = true;
            }
        });

        // Theme toggle uses localStorage (local preference)
        themeToggleBtn.addEventListener('click', () => {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                 themeToggleBtn.textContent = "Toggle Dark Mode";
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                 themeToggleBtn.textContent = "Toggle Light Mode";
            }
            // No need to call render() just for theme unless styles depend on JS state
        });

        // Reset Button
         resetBtn.addEventListener('click', () => {
             if (confirm("!! WARNING !!\nAre you sure you want to reset ALL rotation data in Firestore?\nThis will reset the member list to the initial default and restart the rotation schedule from the next Monday for EVERYONE using this tool.\nThis cannot be undone easily.")) {
                 console.warn("Resetting data in Firestore!");
                 // Reset local state first
                 const today = new Date();
                 const nextMonday = findNextMonday(today);
                 // Deep copy initial members to avoid modifying the constant
                 state.members = initialMembers.map(m => ({...m}));
                 state.rotationState = {
                     currentDate: getISODateString(nextMonday),
                     r4r5Index: 0,
                     memberIndex: 0,
                     skippedVips: [],
                     selectedMvps: {},
                 };
                 state.previousRotationState = null; // Clear undo buffer

                 // Update Firestore with the reset state
                 updateFirestoreState();
                 // The listener will eventually trigger a render, but render locally too for immediate feedback
                 render();
                 alert("Data has been reset to defaults in Firestore.");
             }
         });

        // --- Initialization and Realtime Updates ---
        stateDocRef.onSnapshot((doc) => {
            console.log("Firestore data received/updated.");
            let needsInitialDateCalculation = false;

            if (doc.exists) {
                const data = doc.data();
                console.log("Data from Firestore:", data);

                // Update local state carefully, preserving local undo state
                const localPreviousState = state.previousRotationState; // Keep local undo state
                 // Perform basic validation and provide defaults for missing fields
                 state = {
                      members: (data.members || []).map(m => ({ ...m, id: m.id || generateId() })), // Ensure members array and IDs
                      rotationState: {
                          currentDate: data.rotationState?.currentDate || null,
                          r4r5Index: data.rotationState?.r4r5Index ?? 0,
                          memberIndex: data.rotationState?.memberIndex ?? 0,
                          skippedVips: data.rotationState?.skippedVips || [], // Ensure array
                          selectedMvps: data.rotationState?.selectedMvps || {}, // Ensure object
                      },
                      previousRotationState: localPreviousState // Restore local undo state
                 };

                // If date is missing after loading, flag to calculate it
                if (!state.rotationState.currentDate) {
                     console.warn("Loaded state missing currentDate.");
                     needsInitialDateCalculation = true;
                 }

            } else {
                // Document doesn't exist - Initialize with defaults and save to Firestore
                console.log("No state document found in Firestore. Initializing with defaults...");
                needsInitialDateCalculation = true; // Also need to calculate date for new setup
                 state = {
                    members: initialMembers.map(m => ({...m})), // Fresh copy
                    rotationState: {
                        currentDate: null, // Will be set below
                        r4r5Index: 0,
                        memberIndex: 0,
                        skippedVips: [],
                        selectedMvps: {},
                    },
                    previousRotationState: null // No undo state initially
                };
            }

            // Calculate and set the date if needed (either missing or initial setup)
            if (needsInitialDateCalculation) {
                 console.log("Calculating initial start date (next Monday).");
                 const today = new Date();
                 const nextMonday = findNextMonday(today);
                 state.rotationState.currentDate = getISODateString(nextMonday);
                 console.log("Setting start date to:", state.rotationState.currentDate);
                 // If the document didn't exist, save the newly initialized state
                 if (!doc.exists) {
                      updateFirestoreState();
                 }
                 // If date was just missing, we might want to save the update? Optional.
                 // For now, let the next user action save it.
            }

            console.log("Final local state after Firestore update/init:", JSON.parse(JSON.stringify(state))); // Log the state being rendered

            // Render the UI with the latest state from Firestore (or defaults)
            render();

        }, (error) => {
            console.error("Error listening to Firestore state:", error);
            alert("FATAL ERROR: Could not connect to the rotation database.\nPlease check your internet connection and ensure Firebase is set up correctly.\nRefresh the page to try again.\n\nError details: " + error.message);
            // Disable critical controls on error
            document.getElementById('vip-actions').style.display = 'none';
            document.getElementById('member-manager').style.pointerEvents = 'none';
             document.getElementById('member-manager').style.opacity = '0.5';
             currentDateEl.textContent = "Connection Error";

        });

        // --- Initial Render for Theme ---
        // Render theme immediately on load based on localStorage preference.
        // Data-dependent rendering happens inside the onSnapshot listener.
        (() => {
             const theme = localStorage.getItem('theme');
             if (theme === 'dark') {
                 document.body.classList.add('dark-mode');
                 themeToggleBtn.textContent = "Toggle Light Mode";
             } else {
                 document.body.classList.remove('dark-mode');
                 themeToggleBtn.textContent = "Toggle Dark Mode";
             }
        })();


    </script>

</body>
</html>