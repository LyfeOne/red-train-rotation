<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[rEd] Train Conductor Rotation - S749 (Shared)</title>
    <style>
        /* Basic Reset & Root Variables */
        :root {
            --bg-color-light: #f4f4f8;
            --text-color-light: #333;
            --card-bg-light: #fff;
            --border-color-light: #ddd;
            --primary-color-light: #007bff;
            --primary-text-light: #fff;
            --accent-color-light: #6c757d;
            --accent-text-light: #fff;
            --highlight-bg-light: #e9ecef;
            --input-bg-light: #fff;
            --input-border-light: #ccc;
            --button-hover-light: #0056b3;
            --remove-btn-light: #dc3545;
            --remove-btn-hover-light: #c82333;
            --skipped-bg-light: #fff3cd;
            --skipped-text-light: #856404;

            --bg-color-dark: #22272e;
            --text-color-dark: #c9d1d9;
            --card-bg-dark: #2d333b;
            --border-color-dark: #444c56;
            --primary-color-dark: #58a6ff;
            --primary-text-dark: #22272e;
            --accent-color-dark: #8b949e;
            --accent-text-dark: #22272e;
            --highlight-bg-dark: #373e47;
            --input-bg-dark: #22272e;
            --input-border-dark: #444c56;
            --button-hover-dark: #79b8ff;
            --remove-btn-dark: #f85149;
            --remove-btn-hover-dark: #da3633;
            --skipped-bg-dark: #3e3a2e;
            --skipped-text-dark: #d4a72c;

            /* Default to light mode variables */
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --primary-color: var(--primary-color-light);
            --primary-text: var(--primary-text-light);
            --accent-color: var(--accent-color-light);
            --accent-text: var(--accent-text-light);
            --highlight-bg: var(--highlight-bg-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --button-hover: var(--button-hover-light);
            --remove-btn: var(--remove-btn-light);
            --remove-btn-hover: var(--remove-btn-hover-light);
            --skipped-bg: var(--skipped-bg-light);
            --skipped-text: var(--skipped-text-light);
        }

        body.dark-mode {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-color-dark);
            --primary-color: var(--primary-color-dark);
            --primary-text: var(--primary-text-dark);
            --accent-color: var(--accent-color-dark);
            --accent-text: var(--accent-text-dark);
            --highlight-bg: var(--highlight-bg-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --button-hover: var(--button-hover-dark);
            --remove-btn: var(--remove-btn-dark);
            --remove-btn-hover: var(--remove-btn-hover-dark);
            --skipped-bg: var(--skipped-bg-dark);
            --skipped-text: var(--skipped-text-dark);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Layout */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 {
             font-size: 1.8em;
             color: var(--primary-color);
        }
        .controls-section, .member-section, .schedule-section, .skipped-section, .stats-section, .admin-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: var(--bg-color); /* Slightly different bg for sections */
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.4em;
        }
        h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        /* Forms and Inputs */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            margin-right: 5px;
            margin-bottom: 5px; /* For wrapping */
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--primary-text);
        }
        .btn-primary:hover {
            background-color: var(--button-hover);
        }
        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--accent-text);
        }
        .btn-secondary:hover {
            opacity: 0.9;
        }
         .btn-remove {
            background-color: var(--remove-btn);
            color: var(--primary-text); /* White text usually works */
            font-size: 0.8em;
            padding: 3px 8px;
        }
        .btn-remove:hover {
            background-color: var(--remove-btn-hover);
        }
        .btn-vip-action {
             margin-top: 10px;
        }

        /* Lists */
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Ensure wrapping on small screens */
        }
        li:last-child {
            border-bottom: none;
        }
        li span {
             margin-right: 10px;
             word-break: break-word; /* Prevent long names breaking layout */
        }

        /* Member List specific styling */
        #member-list li .member-info {
            display: flex;
            align-items: center;
            flex-grow: 1; /* Allow name and rank select to take space */
            margin-right: 10px; /* Space before remove button */
        }
        .rank-badge { /* Kept for potential future use, but replaced by select */
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
            color: var(--accent-text);
            background-color: var(--accent-color);
            white-space: nowrap;
        }
        .rank-select-inline {
            /* Style the inline rank selector */
            display: inline-block;
            width: auto; /* Adjust width */
            padding: 2px 5px;
            margin-left: 8px;
            font-size: 0.9em;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 3px;
            vertical-align: middle; /* Align nicely with the text */
        }
        .rank-R5 { background-color: #dc3545; } /* Might still be used for badges elsewhere */
        .rank-R4 { background-color: #ffc107; color: #333; }
        .rank-Member { background-color: #17a2b8; }

        /* Schedule Display */
        #schedule-display ul li {
            display: grid;
            grid-template-columns: 100px auto auto; /* Date | Conductor | VIP */
            gap: 10px;
            padding: 10px 5px;
            align-items: start;
        }
         #schedule-display ul li.current-day {
            background-color: var(--highlight-bg);
            font-weight: bold;
            border-left: 3px solid var(--primary-color);
            padding-left: 10px;
         }
        .schedule-date { font-weight: bold; }
        .schedule-conductor { }
        .schedule-vip { font-style: italic; }
        .mvp-selection-required {
            color: var(--remove-btn);
            font-weight: bold;
        }

        /* Current Day Section */
        #current-day-info {
            background-color: var(--highlight-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        #current-day-info p { margin-bottom: 8px; }
        #mvp-selection-area { display: none; margin-top: 10px; } /* Hidden by default */
        #mvp-selection-area label { margin-right: 10px; }

        /* Skipped VIPs */
        #skipped-vips ul li {
            background-color: var(--skipped-bg);
            color: var(--skipped-text);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
            justify-content: flex-start; /* Align name to the left */
        }

        /* Statistics Section */
        .stats-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 20px; /* Space between MVP and VIP lists */
        }
        #mvp-stats, #vip-stats {
            flex: 1; /* Each takes up half the space */
            min-width: 200px; /* Minimum width before wrapping */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg); /* Match card background */
        }
        #mvp-stats h3, #vip-stats h3 {
             font-size: 1.1em;
             margin-bottom: 10px;
             color: var(--primary-color);
             border-bottom: 1px solid var(--border-color);
             padding-bottom: 5px;
        }
        #mvp-stats ul, #vip-stats ul {
            list-style: none;
            padding: 0;
            max-height: 300px; /* Prevent super long lists */
            overflow-y: auto; /* Add scroll if needed */
        }
         #mvp-stats li, #vip-stats li {
             padding: 5px 0;
             border-bottom: 1px dashed var(--border-color);
             display: flex;
             justify-content: space-between;
             font-size: 0.9em;
         }
        #mvp-stats li:last-child, #vip-stats li:last-child {
             border-bottom: none;
         }
         .stats-count {
             font-weight: bold;
             margin-left: 10px;
             min-width: 20px; /* Ensure space for count */
             text-align: right;
         }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 15px;
            z-index: 100;
        }

        /* Admin Controls */
        .admin-section {
             margin-top: 20px;
             padding-top: 15px;
             border-top: 1px solid var(--border-color);
        }
         .admin-section button {
             margin-right: 10px;
         }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.2em; }
            button { font-size: 0.9em; padding: 8px 12px; }
            .theme-toggle { top: 5px; right: 5px; }

            #schedule-display ul li {
                grid-template-columns: 80px auto; /* Date | Conductor + VIP */
                gap: 5px;
                row-gap: 2px; /* Reduce space between rows when wrapped */
            }
            #schedule-display ul li > span:nth-child(2) { grid-column: 2; } /* Conductor */
            #schedule-display ul li > span:nth-child(3) { grid-column: 2; } /* VIP */

            li { flex-direction: column; align-items: flex-start; }
            li span { margin-bottom: 5px; }
            #member-list li { flex-direction: row; align-items: center; } /* Keep member list items horizontal */
            #member-list li .member-info { margin-bottom: 0; }
            .member-actions { margin-top: 5px; margin-left: auto; } /* Push remove btn to right */
        }
         @media (max-width: 480px) {
              h1 { font-size: 1.3em; }
              .header { margin-bottom: 15px; }
               #schedule-display ul li {
                  grid-template-columns: 65px auto; /* Smaller date column */
               }
               .schedule-date { font-size: 0.9em; }
               #member-list li { flex-direction: column; align-items: flex-start; } /* Stack on very small screens */
               .member-actions { margin-left: 0; }
         }

    </style>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

</head>
<body>

    <button id="theme-toggle" class="theme-toggle btn-secondary">Toggle Dark Mode</button>

    <div class="container">
        <header class="header">
            <h1>[rEd] Dead Redemption - Train Conductor Rotation</h1>
            <p>Server #749 (Shared)</p>
        </header>

        <!-- Current Day and Controls -->
        <section class="controls-section">
            <h2>Current Rotation Status</h2>
            <div id="current-day">
                <div id="current-day-info">
                    <p><strong>Date:</strong> <span id="current-date">Loading...</span></p>
                    <p><strong>Day:</strong> <span id="current-day-of-week">---</span></p>
                    <p><strong>Conductor:</strong> <span id="current-conductor">---</span></p>
                    <p><strong>Proposed VIP:</strong> <span id="current-vip">---</span></p>
                </div>

                <div id="mvp-selection-area">
                    <label for="mvp-select">Select Today's MVP Conductor:</label>
                    <select id="mvp-select">
                        <option value="">-- Select MVP --</option>
                    </select>
                </div>

                <div id="vip-actions">
                     <p>Did the proposed VIP accept?</p>
                     <button id="vip-accepted" class="btn-primary btn-vip-action">Yes, VIP Accepted</button>
                     <button id="vip-skipped" class="btn-secondary btn-vip-action">No, VIP Skipped</button>
                </div>
                 <div id="advance-controls" style="margin-top: 15px;">
                    <button id="undo-advance" class="btn-secondary">Undo Last Advancement</button>
                 </div>
            </div>
        </section>

        <!-- Skipped VIPs Queue -->
        <section class="skipped-section">
             <h2>Skipped VIP Queue (Priority)</h2>
             <div id="skipped-vips">
                 <p>Members who skipped will appear here and be offered VIP again first.</p>
                 <ul>
                     <!-- Skipped VIPs will be listed here -->
                 </ul>
             </div>
        </section>

        <!-- Rotation Schedule -->
        <section class="schedule-section">
             <h2>Upcoming Rotation Schedule</h2>
             <p>Showing the next full cycle of Members receiving VIP.</p>
             <div id="schedule-display">
                  <ul>
                      <!-- Schedule will be generated here -->
                  </ul>
             </div>
        </section>

        <!-- Member Management -->
        <section class="member-section">
            <h2>Manage Alliance Members</h2>
            <div id="member-manager">
                <h3>Add New Member</h3>
                <form id="add-member-form" class="form-group">
                    <label for="new-member-name">Name:</label>
                    <input type="text" id="new-member-name" required>
                    <label for="new-member-rank">Rank:</label>
                    <select id="new-member-rank">
                        <option value="Member">Member</option>
                        <option value="R4">R4</option>
                        <option value="R5">R5</option>
                    </select>
                    <button type="submit" class="btn-primary" style="margin-top: 10px;">Add Member</button>
                </form>

                <h3>Current Members (<span id="member-count">0</span>)</h3>
                <ul id="member-list">
                    <!-- Member list will be populated here -->
                </ul>
            </div>
        </section>

        <!-- Statistics Section -->
        <section class="stats-section">
            <h2>Statistics</h2>
            <div class="stats-container">
                <div id="mvp-stats">
                    <h3>MVP Counts</h3>
                    <ul><!-- MVP counts will be listed here --></ul>
                </div>
                <div id="vip-stats">
                    <h3>VIP Counts</h3>
                    <ul><!-- VIP counts will be listed here --></ul>
                </div>
            </div>
        </section>

        <!-- Admin Controls -->
        <section class="admin-section">
            <h2>Admin</h2>
            <p>Use reset only if absolutely necessary. It affects everyone.</p>
            <button id="reset-data" class="btn-remove">Reset All Data to Defaults</button>
        </section>

    </div>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace placeholders with your actual Firebase project config!
        // Make sure Firestore is enabled in your Firebase project.
        // Make sure Firestore Security Rules allow read/write access to the 'rotationState/s749_state' document.
        const firebaseConfig = {
          apiKey: "AIzaSyAT8L9vDqFHyGB-MybtcLEBgCALuNflTZY", // Replace
          authDomain: "red-train-rotation-tool.firebaseapp.com", // Replace
          projectId: "red-train-rotation-tool", // Replace
          storageBucket: "red-train-rotation-tool.firebasestorage.app", // Replace
          messagingSenderId: "178389819926", // Replace
          appId: "1:178389819926:web:bd59c273641ab8530ccb37" // Replace
        };

        // --- Initialize Firebase (using Compat libraries) ---
        try {
             firebase.initializeApp(firebaseConfig);
        } catch (e) {
             console.error("Error initializing Firebase. Is the config correct?", e);
             alert("Could not initialize Firebase. Check configuration and console.");
        }
        const db = firebase.firestore(); // Get Firestore instance

        // --- Firestore Document Reference ---
        const stateDocRef = db.collection("rotationState").doc("s749_state");

        // --- Constants and State ---
        const MVP_TECH_DAY = 1; // Monday
        const MVP_VS_DAY = 0;   // Sunday
        const RANKS = ["Member", "R4", "R5"]; // Define ranks for dropdown

        // Local state object - Overwritten by Firestore data on load/update
        let state = {
            members: [],
            rotationState: {
                currentDate: null, // ISO String YYYY-MM-DD
                r4r5Index: 0,
                memberIndex: 0,
                skippedVips: [], // Array of member IDs
                selectedMvps: {}, // Key: "YYYY-MM-DD_Sun" or "YYYY-MM-DD_Mon", Value: memberId
                vipCounts: {},    // { memberId: count } - NEW
                mvpCounts: {}     // { memberId: count } - NEW
            },
            // previousRotationState is managed *only* locally in browser memory for undo
            previousRotationState: null
        };

        // --- Initial Data (Only used if Firestore is empty on first load) ---
         const initialMembers = [
            // Using the list from the prompt, adding IDs
            { name: "Motherfrogger", rank: "R5"}, { name: "Enyaisrave", rank: "R4"}, { name: "Johcar", rank: "R4"},
            { name: "DaVinnie", rank: "R4"}, { name: "CornFlakes", rank: "R4"}, { name: "Lyfe", rank: "R4"},
            { name: "LadyLaik", rank: "R4"}, { name: "Pabs64", rank: "R4"}, { name: "Supersebb", rank: "R4"},
            { name: "Munky", rank: "R4"}, { name: "NymbleV", rank: "R4"}, { name: "R1/R2/R3 Team", rank: "Member"}, // Included from your code example
            { name: "Smugwell", rank: "Member"}, { name: "MRAN", rank: "Member"}, { name: "Chris", rank: "Member"},
            { name: "Leka98", rank: "Member"}, { name: "Darkknight", rank: "Member"}, { name: "Rikkyyyyy", rank: "Member"},
            { name: "Gekkegerrittttt", rank: "Member"}, { name: "Ever4", rank: "Member"}, { name: "KFCPov3r", rank: "Member"},
            { name: "F L A C", rank: "Member"}, { name: "Jotersan", rank: "Member"}, { name: "Novis01", rank: "Member"},
            { name: "Gorkiules", rank: "Member"}, { name: "Jaista", rank: "Member"}, { name: "Megalomanie", rank: "Member"},
            { name: "АЛЕКС1980", rank: "Member"}, { name: "TheFloh", rank: "Member"}, { name: "Caretta", rank: "Member"},
            { name: "Swisskilla", rank: "Member"}, { name: "Llama deDrama", rank: "Member"}, { name: "oo APACHE oo", rank: "Member"},
            { name: "GoFireES", rank: "Member"}, { name: "Foggis", rank: "Member"}, { name: "Paracitus", rank: "Member"},
            { name: "IRONHAMMER", rank: "Member"}, { name: "jarako", rank: "Member"}, { name: "Be a wolf", rank: "Member"},
            { name: "Commander Blad", rank: "Member"}, { name: "ILYES B", rank: "Member"}, { name: "KingStridez", rank: "Member"},
            { name: "diRty freNk", rank: "Member"}, { name: "PavlosP", rank: "Member"}, { name: "Chasseur 777", rank: "Member"},
            { name: "Raph911", rank: "Member"}, { name: "B1wizz", rank: "Member"}, { name: "Thirteen Squid", rank: "Member"},
            { name: "ЖЭКА", rank: "Member"}, { name: "SkyWinder", rank: "Member"}, { name: "FireXice (Bibot)", rank: "Member"},
            { name: "GhósT", rank: "Member"}, { name: "Juantxo79", rank: "Member"}, { name: "Kezual", rank: "Member"},
            { name: "Maytos", rank: "Member"}, { name: "jassådu", rank: "Member"}, { name: "Temd", rank: "Member"},
            { name: "olabaf", rank: "Member"}, { name: "Faluche", rank: "Member"}, { name: "xPerseus", rank: "Member"},
            { name: "Lutonian", rank: "Member"}, { name: "Juggernaut x", rank: "Member"}, { name: "Umbra XIII", rank: "Member"},
            { name: "BLÀDE", rank: "Member"}, { name: "koppies", rank: "Member"}, { name: "Cocsi29400", rank: "Member"},
            { name: "Nohardfeelz", rank: "Member"}, { name: "Vechniy", rank: "Member"}, { name: "theFoxXx", rank: "Member"},
            { name: "S A M U R A i", rank: "Member"}, { name: "Dfyra", rank: "Member"}, { name: "Meloziaa", rank: "Member"},
            { name: "Aminos77", rank: "Member"}, { name: "Rev T", rank: "Member"}, { name: "BlackWizardUA", rank: "Member"},
            { name: "Bekim1", rank: "Member"}, { name: "Edx777", rank: "Member"}, { name: "Laeta", rank: "Member"},
            { name: "Kyuchie", rank: "Member"}, { name: "depechefann", rank: "Member"}, { name: "BlackPush", rank: "Member"},
            { name: "Gunnovic", rank: "Member"}, { name: "NinoDelBono", rank: "Member"}, { name: "Dario217", rank: "Member"}
            // Add any other members from the original prompt if needed
        ].map(m => ({ ...m, id: generateId() })); // Add unique IDs

        // --- DOM Elements ---
        const memberListEl = document.getElementById('member-list');
        const addMemberForm = document.getElementById('add-member-form');
        const newMemberNameInput = document.getElementById('new-member-name');
        const newMemberRankSelect = document.getElementById('new-member-rank');
        const memberCountEl = document.getElementById('member-count');
        const currentDateEl = document.getElementById('current-date');
        const currentDayOfWeekEl = document.getElementById('current-day-of-week');
        const currentConductorEl = document.getElementById('current-conductor');
        const currentVipEl = document.getElementById('current-vip');
        const skippedVipsListEl = document.getElementById('skipped-vips').querySelector('ul');
        const scheduleDisplayListEl = document.getElementById('schedule-display').querySelector('ul');
        const vipAcceptedBtn = document.getElementById('vip-accepted');
        const vipSkippedBtn = document.getElementById('vip-skipped');
        const undoAdvanceBtn = document.getElementById('undo-advance');
        const mvpSelectionArea = document.getElementById('mvp-selection-area');
        const mvpSelect = document.getElementById('mvp-select');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const resetBtn = document.getElementById('reset-data');
        const mvpStatsListEl = document.getElementById('mvp-stats').querySelector('ul'); // New for stats
        const vipStatsListEl = document.getElementById('vip-stats').querySelector('ul'); // New for stats


        // --- Utility Functions ---
        function generateId() { return Math.random().toString(36).substring(2, 15); }
        function getDayOfWeek(date) { return date.getDay(); } // 0 = Sunday
        function formatDate(date) {
             if (!(date instanceof Date) || isNaN(date)) return "Invalid Date";
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }
        function getISODateString(date) {
             if (!(date instanceof Date) || isNaN(date)) {
                 console.error("getISODateString received invalid date:", date);
                 return new Date().toISOString().split('T')[0]; // Fallback to today
             }
            return date.toISOString().split('T')[0];
        }
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        function findNextMonday(date) {
            const currentDay = getDayOfWeek(date);
            const daysUntilMonday = (8 - currentDay) % 7;
            const daysToAdd = daysUntilMonday === 0 ? 7 : daysUntilMonday;
            return addDays(date, daysToAdd);
        }
        function getMemberById(id) {
             if (!Array.isArray(state.members)) return null;
            return state.members.find(m => m && m.id === id); // Added check for m existence
        }
        function getMembersByRank(rank) {
             if (!Array.isArray(state.members)) return [];
             if (rank === 'R4/R5') {
                return state.members.filter(m => m && (m.rank === 'R4' || m.rank === 'R5'));
             }
            return state.members.filter(m => m && m.rank === rank);
        }

        // --- Core Logic Functions ---
        function calculateDailyAssignments(targetDateStr, currentR4R5Index, currentMemberIndex, currentSkippedVips, selectedMvpsMap) {
            // Basic parameter validation
            if (!targetDateStr || typeof currentR4R5Index !== 'number' || typeof currentMemberIndex !== 'number' || !Array.isArray(currentSkippedVips) || typeof selectedMvpsMap !== 'object') {
                console.error("Invalid parameters in calculateDailyAssignments");
                return { date: new Date(), conductor: { id: 'ERROR_PARAMS', name: 'Invalid Input', rank: 'System' }, vip: { id: 'ERROR_PARAMS', name: 'Invalid Input', rank: 'System' } };
            }

            const targetDate = new Date(targetDateStr + 'T00:00:00Z'); // Use UTC
            if (isNaN(targetDate)) {
                 console.error("Invalid date string for calculation:", targetDateStr);
                 return { date: new Date(), conductor: { id: 'ERROR_DATE', name: 'Invalid Date', rank: 'System' }, vip: { id: 'ERROR_DATE', name: 'Invalid Date', rank: 'System' } };
            }
            const dayOfWeek = getDayOfWeek(targetDate);

            let conductor = null;
            let vip = null;
            const r4r5Members = getMembersByRank('R4/R5');
            const memberMembers = getMembersByRank('Member');

            // Determine Conductor
            if (dayOfWeek === MVP_TECH_DAY) { // Monday
                 const mvpKey = `${targetDateStr}_Mon`;
                 const selectedMvpId = selectedMvpsMap[mvpKey];
                 conductor = selectedMvpId ? getMemberById(selectedMvpId) : { id: 'MVP_MON_SELECT', name: 'Tech MVP Selection Required', rank: 'MVP' };
            } else if (dayOfWeek === MVP_VS_DAY) { // Sunday
                 const mvpKey = `${targetDateStr}_Sun`;
                 const selectedMvpId = selectedMvpsMap[mvpKey];
                 conductor = selectedMvpId ? getMemberById(selectedMvpId) : { id: 'MVP_SUN_SELECT', name: 'VS MVP Selection Required', rank: 'MVP' };
            } else { // Tuesday - Saturday
                if (r4r5Members.length > 0) {
                    conductor = r4r5Members[currentR4R5Index % r4r5Members.length];
                } else {
                    conductor = { id: 'NO_R4R5', name: 'No R4/R5 Available', rank: 'System' };
                }
            }

            // Determine VIP (Member)
             // Filter skipped VIPs to ensure they still exist in the member list
             const validSkippedVips = currentSkippedVips.filter(id => getMemberById(id));
             if (validSkippedVips.length > 0) {
                  vip = getMemberById(validSkippedVips[0]);
                  // If the original skipped list had invalid IDs, we might need to update the state,
                  // but let's handle that on advancement instead of here.
             } else if (memberMembers.length > 0) {
                 vip = memberMembers[currentMemberIndex % memberMembers.length];
             } else {
                 vip = { id: 'NO_MEMBERS', name: 'No Members Available', rank: 'System' };
             }

            conductor = conductor || { id: 'ERROR_CONDUCTOR', name: 'Error Conductor', rank: 'System' };
            vip = vip || { id: 'ERROR_VIP', name: 'Error VIP', rank: 'System' };

            return { date: targetDate, conductor, vip };
        }

        function advanceRotation(vipAccepted, selectedMvpId = null) {
            console.log('Advancing Rotation - VIP Accepted:', vipAccepted, 'Selected MVP:', selectedMvpId);
            if (!state.rotationState || !state.rotationState.currentDate) {
                 console.error("Cannot advance rotation: state or currentDate is missing.");
                 return false; // Indicate failure
             }

            const currentDateStr = state.rotationState.currentDate;
            const currentDate = new Date(currentDateStr + 'T00:00:00Z');
            const currentDayOfWeek = getDayOfWeek(currentDate);
            const currentR4R5Index = state.rotationState.r4r5Index ?? 0; // Default to 0 if null/undefined
            const currentMemberIndex = state.rotationState.memberIndex ?? 0; // Default to 0
            const currentSkippedVips = [...(state.rotationState.skippedVips || [])]; // Ensure array, then copy
            const currentVipCounts = { ...(state.rotationState.vipCounts || {}) }; // Ensure object, then copy
            const currentMvpCounts = { ...(state.rotationState.mvpCounts || {}) }; // Ensure object, then copy
            const currentSelectedMvps = { ...(state.rotationState.selectedMvps || {}) }; // Ensure object, then copy


            // Determine the VIP who was proposed for the *current* day
            const { vip: proposedVip } = calculateDailyAssignments(
                currentDateStr,
                currentR4R5Index,
                currentMemberIndex,
                currentSkippedVips, // Use current valid skipped list
                currentSelectedMvps
            );

            if (!proposedVip || !proposedVip.id || proposedVip.id.startsWith('NO_') || proposedVip.id.startsWith('ERROR_')) {
                 console.warn("Cannot advance: No valid VIP proposed for today.");
                 alert("Cannot advance: No valid VIP was proposed for today. Check Member list.");
                 return false; // Indicate failure
            }
            const proposedVipId = proposedVip.id;

            // Update indices and skipped list based on VIP action
            let nextR4R5Index = currentR4R5Index;
            let nextMemberIndex = currentMemberIndex;
            let nextSkippedVips = [...currentSkippedVips]; // Work on a fresh copy

            // Ensure skipped list only contains valid members before processing
             nextSkippedVips = nextSkippedVips.filter(id => getMemberById(id));
             const wasVipFromSkippedList = nextSkippedVips.length > 0 && nextSkippedVips[0] === proposedVipId;

            if (vipAccepted) {
                if (wasVipFromSkippedList) {
                    nextSkippedVips.shift(); // Remove accepted VIP from *start* of skipped list
                } else {
                    nextMemberIndex = (currentMemberIndex + 1); // Advance regular index
                }
                 // Increment VIP count
                 currentVipCounts[proposedVipId] = (currentVipCounts[proposedVipId] || 0) + 1;
                 console.log(`VIP Count for ${proposedVip.name} incremented to ${currentVipCounts[proposedVipId]}`);

            } else { // VIP Skipped
                if (!wasVipFromSkippedList && !nextSkippedVips.includes(proposedVipId)) {
                     // Add to *front* of skipped list only if not already there & not already skipped
                     nextSkippedVips.unshift(proposedVipId);
                     console.log(`${proposedVip.name} added to skipped list.`);
                     // Member index does NOT advance
                 } else if (wasVipFromSkippedList) {
                     console.log(`${proposedVip.name} was already skipped, remains at front.`);
                     // Member index does NOT advance
                 } else {
                    console.log(`${proposedVip.name} skipped, but already in skipped list later? No index advance.`);
                    // Member index does NOT advance
                 }
                 // VIP count does NOT increment if skipped
            }

            // Advance R4/R5 index ONLY if transitioning from a Tue-Sat day
            if (currentDayOfWeek >= 2 && currentDayOfWeek <= 6) {
                nextR4R5Index = (currentR4R5Index + 1);
            }

             // Store selected MVP and increment count if provided for today
             if (selectedMvpId) {
                 const member = getMemberById(selectedMvpId);
                 if (member) { // Check if member exists
                     const mvpKeyBase = currentDayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`;
                     currentSelectedMvps[mvpKeyBase] = selectedMvpId;
                     currentMvpCounts[selectedMvpId] = (currentMvpCounts[selectedMvpId] || 0) + 1;
                     console.log(`MVP ${member.name} selected. Count incremented to ${currentMvpCounts[selectedMvpId]}`);
                 } else {
                     console.warn(`Selected MVP ID ${selectedMvpId} not found in members list.`);
                 }
             }

            // Calculate next date
            const nextDate = addDays(currentDate, 1);
            const nextDateStr = getISODateString(nextDate);

            // Update the local state object directly
            state.rotationState.currentDate = nextDateStr;
            state.rotationState.r4r5Index = nextR4R5Index;
            state.rotationState.memberIndex = nextMemberIndex;
            state.rotationState.skippedVips = nextSkippedVips;
            state.rotationState.selectedMvps = currentSelectedMvps; // Update with potentially new MVP
            state.rotationState.vipCounts = currentVipCounts; // Update counts
            state.rotationState.mvpCounts = currentMvpCounts; // Update counts

            console.log("Local state advanced. New State:", JSON.parse(JSON.stringify(state.rotationState)));
            return true; // Indicate success
        }

        // --- Firestore Persistence ---
        function updateFirestoreState() {
            // Prepare the state object to save (exclude local-only previousRotationState)
            const stateToSave = {
                 members: state.members || [], // Ensure array
                 rotationState: {
                      currentDate: state.rotationState.currentDate,
                      r4r5Index: state.rotationState.r4r5Index ?? 0,
                      memberIndex: state.rotationState.memberIndex ?? 0,
                      skippedVips: state.rotationState.skippedVips || [], // Ensure array
                      selectedMvps: state.rotationState.selectedMvps || {}, // Ensure object
                      vipCounts: state.rotationState.vipCounts || {},    // NEW: Save counts
                      mvpCounts: state.rotationState.mvpCounts || {}     // NEW: Save counts
                 }
            };

            console.log("Attempting to write to Firestore:", JSON.parse(JSON.stringify(stateToSave)));
            return stateDocRef.set(stateToSave) // Return the promise
                .then(() => {
                    console.log("State successfully written to Firestore!");
                })
                .catch((error) => {
                    console.error("Error writing state to Firestore: ", error);
                    alert(`Error saving changes: ${error.message}. Check Firestore rules and console.`);
                    throw error; // Re-throw error for calling function
                });
        }

        // --- Member Management Functions ---
        function addMember(event) {
            event.preventDefault();
            const name = newMemberNameInput.value.trim();
            const rank = newMemberRankSelect.value;

            if (name && rank) {
                if (!Array.isArray(state.members)) state.members = []; // Ensure array exists
                if (state.members.some(m => m && m.name.toLowerCase() === name.toLowerCase())) {
                     alert(`Member "${name}" already exists.`);
                     return;
                 }
                const newMember = { id: generateId(), name: name, rank: rank };
                state.members.push(newMember);
                sortMembers(); // Sort the local state
                updateFirestoreState(); // Push the updated state
                newMemberNameInput.value = '';
            } else {
                alert("Please enter both name and rank.");
            }
        }

        function removeMember(idToRemove) {
            const memberToRemove = getMemberById(idToRemove);
            if (!memberToRemove) return;

             if (confirm(`Are you sure you want to remove ${memberToRemove.name}? This will update for everyone and remove them from rotation/skipped lists.`)) {
                if (!Array.isArray(state.members)) state.members = [];
                state.members = state.members.filter(member => member && member.id !== idToRemove);

                if (!state.rotationState) state.rotationState = {}; // Ensure exists

                // Remove from skipped list
                if (!Array.isArray(state.rotationState.skippedVips)) state.rotationState.skippedVips = [];
                state.rotationState.skippedVips = state.rotationState.skippedVips.filter(id => id !== idToRemove);

                // Optional: Clear from selected MVPs history (or leave history intact?) - Leaving intact for now.
                // Optional: Clear counts? Let's leave counts for historical record for now.

                updateFirestoreState(); // Update Firestore
             }
        }

        function handleRankChange(event) { // NEW Function for rank editing
            const selectElement = event.target;
            const memberId = selectElement.dataset.memberId;
            const newRank = selectElement.value;

            const memberIndex = state.members.findIndex(m => m && m.id === memberId);
            if (memberIndex === -1) {
                console.error("Member not found for rank change:", memberId);
                return;
            }
            const memberName = state.members[memberIndex].name;

            // Avoid unnecessary updates
             if (state.members[memberIndex].rank === newRank) {
                 return;
             }

            if (confirm(`Change rank of ${memberName} to ${newRank}? This affects sorting and rotation logic.`)) {
                state.members[memberIndex].rank = newRank;
                console.log(`Rank changed locally for ${memberName} (${memberId}) to ${newRank}`);
                sortMembers(); // Re-sort based on new rank
                updateFirestoreState(); // Save changes
            } else {
                selectElement.value = state.members[memberIndex].rank; // Reset dropdown if cancelled
            }
        }


        function sortMembers() {
             if (!Array.isArray(state.members)) return;
            const rankOrder = { 'R5': 1, 'R4': 2, 'Member': 3 };
            state.members.sort((a, b) => {
                 // Handle cases where a or b might be null/undefined temporarily
                 const rankA = a?.rank;
                 const rankB = b?.rank;
                 const nameA = a?.name || "";
                 const nameB = b?.name || "";

                 const rankDiff = (rankOrder[rankA] || 99) - (rankOrder[rankB] || 99);
                 if (rankDiff !== 0) return rankDiff;
                 return nameA.localeCompare(nameB);
            });
        }


        // --- Rendering Functions ---
        function renderMemberList() {
            memberListEl.innerHTML = '';
             if (!Array.isArray(state.members)) {
                 memberListEl.innerHTML = '<li>Error loading members.</li>';
                 memberCountEl.textContent = 'Error';
                 return;
             }
            memberCountEl.textContent = state.members.length;
            sortMembers(); // Ensure sorted before rendering

            if (state.members.length === 0) {
                memberListEl.innerHTML = '<li>No members added yet.</li>';
                return;
            }

            state.members.forEach(member => {
                 if (!member || !member.id || !member.name || !member.rank) return; // Skip invalid entries

                const li = document.createElement('li');
                li.dataset.memberId = member.id;

                const memberInfo = document.createElement('div'); // Use div for flex container
                memberInfo.classList.add('member-info');

                const nameSpan = document.createElement('span');
                nameSpan.textContent = member.name;
                memberInfo.appendChild(nameSpan);

                // --- Rank Select Dropdown ---
                const rankSelect = document.createElement('select');
                rankSelect.classList.add('rank-select-inline');
                rankSelect.dataset.memberId = member.id;
                RANKS.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r;
                    option.textContent = r;
                    if (member.rank === r) {
                        option.selected = true;
                    }
                    rankSelect.appendChild(option);
                });
                rankSelect.addEventListener('change', handleRankChange); // Attach listener
                memberInfo.appendChild(rankSelect);
                // --- End Rank Select ---

                const actions = document.createElement('div');
                actions.classList.add('member-actions');
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.classList.add('btn-remove');
                removeBtn.onclick = () => removeMember(member.id);
                actions.appendChild(removeBtn);

                li.appendChild(memberInfo); // Add the info container
                li.appendChild(actions);    // Add the actions container
                memberListEl.appendChild(li);
            });
        }

        function renderCurrentDay() {
            if (!state.rotationState || !state.rotationState.currentDate) {
                currentDateEl.textContent = "Not Initialized";
                currentDayOfWeekEl.textContent = "---";
                currentConductorEl.textContent = "---";
                currentVipEl.textContent = "---";
                document.getElementById('vip-actions').style.display = 'none';
                mvpSelectionArea.style.display = 'none';
                undoAdvanceBtn.disabled = true;
                return;
            }

            const currentDate = new Date(state.rotationState.currentDate + 'T00:00:00Z');
             if (isNaN(currentDate)) {
                 currentDateEl.textContent = "Invalid Date!"; return;
             }
            const dayOfWeek = getDayOfWeek(currentDate);

            // Ensure counts are objects before passing
             const safeSelectedMvps = state.rotationState.selectedMvps || {};
             const safeSkippedVips = state.rotationState.skippedVips || [];

            const { conductor, vip } = calculateDailyAssignments(
                state.rotationState.currentDate,
                state.rotationState.r4r5Index ?? 0,
                state.rotationState.memberIndex ?? 0,
                 safeSkippedVips,
                 safeSelectedMvps
            );

             if (!conductor || !vip || conductor.id?.startsWith('ERROR_') || vip.id?.startsWith('ERROR_')) {
                  currentDateEl.textContent = formatDate(currentDate);
                  currentDayOfWeekEl.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
                  currentConductorEl.textContent = conductor.name || "Error";
                  currentVipEl.textContent = vip.name || "Error";
                  document.getElementById('vip-actions').style.display = 'none';
                  mvpSelectionArea.style.display = 'none';
                   undoAdvanceBtn.disabled = true;
                  return;
             }

            currentDateEl.textContent = formatDate(currentDate);
            currentDayOfWeekEl.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });

            let isMvpSelectionNeeded = false;
            const conductorName = conductor.name || "Unknown";
            const conductorRank = conductor.rank || "N/A";
            if (conductor.id === 'MVP_MON_SELECT' || conductor.id === 'MVP_SUN_SELECT') {
                 currentConductorEl.innerHTML = `<span class="mvp-selection-required">${conductorName}</span>`;
                 isMvpSelectionNeeded = true;
                 populateMvpSelect();
                 mvpSelectionArea.style.display = 'block';
                 mvpSelect.value = ""; // Reset selection
            } else {
                currentConductorEl.textContent = `${conductorName} (${conductorRank})`;
                mvpSelectionArea.style.display = 'none';
            }

             const vipName = vip.name || "Unknown";
             const vipRank = vip.rank || "N/A";
             let isVipActionPossible = false;
            if (vip.id === 'NO_MEMBERS' || vip.id === 'ERROR_VIP') {
                currentVipEl.textContent = vipName;
                document.getElementById('vip-actions').style.display = 'none';
            } else {
                currentVipEl.textContent = `${vipName} (${vipRank})`;
                document.getElementById('vip-actions').style.display = 'block';
                isVipActionPossible = true;
            }

             // Enable/Disable VIP action buttons based on MVP requirement *and* if VIP is valid
             vipAcceptedBtn.disabled = !isVipActionPossible || isMvpSelectionNeeded;
             vipSkippedBtn.disabled = !isVipActionPossible || isMvpSelectionNeeded;

            undoAdvanceBtn.disabled = !state.previousRotationState;
        }


        function populateMvpSelect() {
            mvpSelect.innerHTML = '<option value="">-- Select MVP --</option>';
             if (!Array.isArray(state.members)) return;
            // Maybe filter who can be MVP? For now, list all.
            state.members.forEach(member => {
                if (!member || !member.id) return;
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.rank})`;
                mvpSelect.appendChild(option);
            });
        }

        function renderSkippedVips() {
            skippedVipsListEl.innerHTML = '';
            if (!state.rotationState || !Array.isArray(state.rotationState.skippedVips)) {
                skippedVipsListEl.innerHTML = '<li>Error loading skipped list.</li>';
                return;
            }
             const validSkippedVips = state.rotationState.skippedVips.filter(id => getMemberById(id));

            if (validSkippedVips.length === 0) {
                skippedVipsListEl.innerHTML = '<li>Queue is empty.</li>';
                return;
            }
            validSkippedVips.forEach(memberId => {
                const member = getMemberById(memberId);
                if (member) { // Should always be true now due to filter
                    const li = document.createElement('li');
                    li.textContent = `${member.name} (${member.rank})`;
                    skippedVipsListEl.appendChild(li);
                }
            });
        }

        function renderSchedule() {
             scheduleDisplayListEl.innerHTML = '';
             if (!state.rotationState || !state.rotationState.currentDate || !Array.isArray(state.members)) {
                 scheduleDisplayListEl.innerHTML = '<li>Rotation not ready or no members.</li>';
                 return;
             }
             const memberMembers = getMembersByRank('Member');
             if (memberMembers.length === 0) {
                 scheduleDisplayListEl.innerHTML = '<li>No "Member" rank players available for VIP rotation.</li>';
                 return;
             }

             const validSkippedVips = (state.rotationState.skippedVips || []).filter(id => getMemberById(id));
             // Show roughly one full cycle of members + skipped, or at least 7 days
             const scheduleLength = Math.max(7, memberMembers.length + validSkippedVips.length);

             let tempDate = new Date(state.rotationState.currentDate + 'T00:00:00Z');
             let tempR4R5Index = state.rotationState.r4r5Index ?? 0;
             let tempMemberIndex = state.rotationState.memberIndex ?? 0;
             let tempSkippedVips = [...validSkippedVips];
             let tempSelectedMvps = JSON.parse(JSON.stringify(state.rotationState.selectedMvps || {}));

             for (let i = 0; i < scheduleLength; i++) {
                  if (isNaN(tempDate)) {
                      console.error("Invalid date encountered during schedule render");
                      break; // Stop if date becomes invalid
                  }
                 const dateStr = getISODateString(tempDate);
                 const dayOfWeek = getDayOfWeek(tempDate);

                 const { conductor, vip } = calculateDailyAssignments(
                     dateStr, tempR4R5Index, tempMemberIndex, tempSkippedVips, tempSelectedMvps
                 );

                 // Skip rendering if calculation fails for a future date
                 if (conductor.id?.startsWith('ERROR_') || vip.id?.startsWith('ERROR_')) {
                      console.warn(`Schedule calculation error on ${dateStr}`);
                       // Advance date and indices without rendering this day
                 } else {
                     // Render the list item
                     const li = document.createElement('li');
                     if (i === 0) li.classList.add('current-day');

                     const dateSpan = document.createElement('span');
                     dateSpan.classList.add('schedule-date');
                     dateSpan.textContent = formatDate(tempDate);

                     const conductorSpan = document.createElement('span');
                     conductorSpan.classList.add('schedule-conductor');
                     const cName = conductor.name || "Unknown";
                     const cRank = conductor.rank || "N/A";
                     if (conductor.id === 'MVP_MON_SELECT' || conductor.id === 'MVP_SUN_SELECT') {
                          // Show MVP required *if* it hasn't been selected yet for that future date
                           const mvpKey = dayOfWeek === MVP_TECH_DAY ? `${dateStr}_Mon` : `${dateStr}_Sun`;
                           if (tempSelectedMvps[mvpKey]) {
                               const selectedMvp = getMemberById(tempSelectedMvps[mvpKey]);
                               conductorSpan.textContent = `C: ${selectedMvp?.name || 'Selected MVP'} (MVP)`;
                           } else {
                               conductorSpan.innerHTML = `<span class="mvp-selection-required">${cName}</span>`;
                           }
                     } else {
                         conductorSpan.textContent = `C: ${cName} (${cRank})`;
                     }

                     const vipSpan = document.createElement('span');
                     vipSpan.classList.add('schedule-vip');
                     const vName = vip.name || "Unknown";
                     const vRank = vip.rank || "N/A";
                     if (vip.id === 'NO_MEMBERS' || vip.id === 'ERROR_VIP') {
                         vipSpan.textContent = vName;
                     } else {
                          vipSpan.textContent = `VIP: ${vName} (${vRank})`;
                          if (tempSkippedVips.length > 0 && tempSkippedVips[0] === vip.id) {
                               vipSpan.textContent += ' (Skipped)';
                          }
                     }

                     li.appendChild(dateSpan);
                     li.appendChild(conductorSpan);
                     li.appendChild(vipSpan);
                     scheduleDisplayListEl.appendChild(li);
                 } // End render check


                 // Simulate advancement for the *next* day's calculation (assuming acceptance)
                 if (vip.id && !vip.id.startsWith('NO_') && !vip.id.startsWith('ERROR_')) {
                     const wasVipFromSkippedList = tempSkippedVips.length > 0 && tempSkippedVips[0] === vip.id;
                     if (wasVipFromSkippedList) {
                         tempSkippedVips.shift();
                     } else {
                         tempMemberIndex = (tempMemberIndex + 1);
                     }
                 }

                 if (dayOfWeek >= 2 && dayOfWeek <= 6) { // Tue-Sat advance R4/R5
                     tempR4R5Index = (tempR4R5Index + 1);
                 }

                 tempDate = addDays(tempDate, 1); // Advance to the next day
             }
        }

        function renderStatistics() { // NEW function for stats
            mvpStatsListEl.innerHTML = '';
            vipStatsListEl.innerHTML = '';

            if (!state.members || state.members.length === 0) {
                mvpStatsListEl.innerHTML = '<li>No members</li>';
                vipStatsListEl.innerHTML = '<li>No members</li>';
                return;
            }

             // Ensure counts are objects
             const mvpCounts = state.rotationState.mvpCounts || {};
             const vipCounts = state.rotationState.vipCounts || {};

            // Sort members alphabetically for display
            const sortedMembersForStats = [...state.members].sort((a, b) => (a?.name || "").localeCompare(b?.name || ""));

            let hasMvpCounts = false;
            sortedMembersForStats.forEach(member => {
                if (!member || !member.id || !member.name) return;
                const count = mvpCounts[member.id] || 0;
                if (count > 0) hasMvpCounts = true; // Check if there are any counts > 0
                const li = document.createElement('li');
                li.textContent = member.name;
                const countSpan = document.createElement('span');
                countSpan.classList.add('stats-count');
                countSpan.textContent = count;
                li.appendChild(countSpan);
                mvpStatsListEl.appendChild(li);
            });
             if (!hasMvpCounts && sortedMembersForStats.length > 0) {
                 mvpStatsListEl.innerHTML = '<li>No MVPs recorded yet.</li>';
             }

            let hasVipCounts = false;
            sortedMembersForStats.forEach(member => {
                 if (!member || !member.id || !member.name) return;
                 const count = vipCounts[member.id] || 0;
                 if (count > 0) hasVipCounts = true;
                 const li = document.createElement('li');
                 li.textContent = member.name;
                 const countSpan = document.createElement('span');
                 countSpan.classList.add('stats-count');
                 countSpan.textContent = count;
                 li.appendChild(countSpan);
                 vipStatsListEl.appendChild(li);
            });
            if (!hasVipCounts && sortedMembersForStats.length > 0) {
                 vipStatsListEl.innerHTML = '<li>No VIPs recorded yet.</li>';
             }

             if (sortedMembersForStats.length === 0) {
                 mvpStatsListEl.innerHTML = '<li>No members</li>';
                 vipStatsListEl.innerHTML = '<li>No members</li>';
             }
        }

        function render() {
            console.log("Rendering UI with current local state...");

            // Apply theme (local preference)
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = "Toggle Light Mode";
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleBtn.textContent = "Toggle Dark Mode";
            }

            renderMemberList();
            renderSkippedVips();
            renderCurrentDay();
            renderSchedule();
            renderStatistics(); // NEW: Render stats

            undoAdvanceBtn.disabled = !state.previousRotationState;
        }

        // --- Event Listeners ---
        addMemberForm.addEventListener('submit', addMember);

        vipAcceptedBtn.addEventListener('click', () => handleVipAction(true));
        vipSkippedBtn.addEventListener('click', () => handleVipAction(false));

        async function handleVipAction(accepted) { // Make async to await Firestore update
            if (!state.rotationState || !state.rotationState.currentDate) {
                 alert("Rotation state not loaded yet. Please wait.");
                 return;
             }

            const currentDateStr = state.rotationState.currentDate;
            const currentDate = new Date(currentDateStr + 'T00:00:00Z');
            const dayOfWeek = getDayOfWeek(currentDate);
            let selectedMvpId = null;

            // Check if MVP selection is required *and* not yet made for today
            if (dayOfWeek === MVP_TECH_DAY || dayOfWeek === MVP_VS_DAY) {
                 const mvpKey = dayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`;
                 const existingMvp = state.rotationState.selectedMvps?.[mvpKey];
                 if (!existingMvp) { // Only require if not already set
                     selectedMvpId = mvpSelect.value;
                     if (!selectedMvpId) {
                         alert("Please select the MVP Conductor for today using the dropdown.");
                         return; // Stop processing
                     }
                 } else {
                     console.log("MVP already selected for today:", existingMvp);
                 }
            }

            // Disable buttons immediately to prevent double clicks
             vipAcceptedBtn.disabled = true;
             vipSkippedBtn.disabled = true;
             undoAdvanceBtn.disabled = true; // Disable undo temporarily

            // Store the CURRENT state locally for potential UNDO *before* advancing
            try {
                state.previousRotationState = JSON.parse(JSON.stringify(state.rotationState));
                 console.log("Stored previous state for undo:", JSON.parse(JSON.stringify(state.previousRotationState)));
             } catch (e) {
                 console.error("Error stringifying state for undo:", e);
                 state.previousRotationState = null; // Clear if error
             }


            // Advance the local state
            const success = advanceRotation(accepted, selectedMvpId);

            if (success) {
                // Push the *new* state to Firestore and wait for it to complete
                 try {
                     await updateFirestoreState();
                     // Re-enable undo button *only after successful save*
                     undoAdvanceBtn.disabled = !state.previousRotationState;
                     console.log("Firestore update successful after VIP action.");
                 } catch (error) {
                     console.error("Failed to save state after VIP action:", error);
                     alert("Error saving the changes. The rotation might not have advanced correctly. Please check the state or try again.");
                     // Rollback local state changes if save fails? Complicated.
                     // For now, just log the error. The listener *should* eventually get the old state back.
                     // Re-enable buttons so user can try again (maybe?)
                      // renderCurrentDay(); // Re-render to potentially re-enable buttons based on old state
                 }
            } else {
                // Advancement failed (e.g., no valid VIP), re-render to show current state/enable buttons
                 console.warn("advanceRotation failed, re-rendering current day.");
                 renderCurrentDay(); // Re-enable buttons based on current (unchanged) state
            }
             // The UI will re-render automatically via the Firestore listener eventually,
             // but renderCurrentDay() was called above if needed, and undo button handled.
        }

        undoAdvanceBtn.addEventListener('click', async () => { // Make async
            if (!state.previousRotationState) {
                alert("No previous state to undo.");
                return;
            }
            if (confirm("Are you sure you want to undo the last advancement? This will revert the date, indices, skipped list, and counts for everyone.")) {
                 // Disable button immediately
                 undoAdvanceBtn.disabled = true;

                // Restore the rotation part of the state from the local backup
                 try {
                     // Ensure previous state is valid before restoring
                     if (typeof state.previousRotationState !== 'object' || state.previousRotationState === null) {
                          throw new Error("Invalid previous state data for undo.");
                     }
                     state.rotationState = JSON.parse(JSON.stringify(state.previousRotationState));
                     state.previousRotationState = null; // Clear the local undo buffer *after* successful restore
                     console.log("Rolled back local state:", JSON.parse(JSON.stringify(state.rotationState)));

                     // Push the rolled-back state to Firestore and wait
                     await updateFirestoreState();
                     console.log("Firestore updated successfully after undo.");
                     // Listener will trigger re-render. Undo button remains disabled as previousRotationState is now null.
                 } catch (error) {
                     console.error("Error during undo process:", error);
                     alert("Error performing undo: " + error.message + ". State might be inconsistent.");
                     // Attempt to re-enable button? Or leave disabled? Leave disabled for safety.
                 }
            }
        });

        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                 themeToggleBtn.textContent = "Toggle Light Mode";
            } else {
                localStorage.setItem('theme', 'light');
                 themeToggleBtn.textContent = "Toggle Dark Mode";
            }
        });

        resetBtn.addEventListener('click', async () => { // Make async
             if (confirm("!! WARNING !!\nAre you sure you want to reset ALL rotation data in Firestore?\nThis resets members to default, restarts schedule from next Monday, and clears counts for EVERYONE.\nThis CANNOT be easily undone.")) {
                 console.warn("Resetting data in Firestore!");
                 // Disable button immediately
                 resetBtn.disabled = true;

                 const today = new Date();
                 const nextMonday = findNextMonday(today);
                 const nextMondayStr = getISODateString(nextMonday);

                 // Reset local state
                 state.members = initialMembers.map(m => ({...m})); // Fresh copy with new IDs? No, keep original IDs for consistency if possible
                 state.rotationState = {
                     currentDate: nextMondayStr,
                     r4r5Index: 0,
                     memberIndex: 0,
                     skippedVips: [],
                     selectedMvps: {},
                     vipCounts: {}, // Reset counts
                     mvpCounts: {}  // Reset counts
                 };
                 state.previousRotationState = null; // Clear undo buffer

                 // Update Firestore with the reset state and wait
                  try {
                      await updateFirestoreState();
                      console.log("Firestore successfully reset to defaults.");
                      alert("Data has been reset to defaults in Firestore.");
                      // Listener will trigger re-render.
                  } catch (error) {
                      console.error("Error resetting Firestore data:", error);
                      alert("Error resetting data. Please check console and Firestore.");
                      // Re-enable button if reset failed
                      resetBtn.disabled = false;
                  }
             }
         });

        // --- Initialization and Realtime Updates ---
        stateDocRef.onSnapshot((doc) => {
            console.log("Firestore data received/updated.");
            let needsInitialSetup = false;
            let needsDateUpdate = false;

            if (doc.exists) {
                const data = doc.data();
                console.log("Raw data from Firestore:", data);

                // Keep local undo state safe
                const localPreviousState = state.previousRotationState;

                 // Validate and structure loaded data, providing defaults
                 const loadedMembers = (data.members || []).map(m => ({ ...m, id: m.id || generateId() })); // Ensure array and IDs
                 const loadedRotationState = data.rotationState || {};

                 state = {
                      members: loadedMembers,
                      rotationState: {
                          currentDate: loadedRotationState.currentDate || null,
                          r4r5Index: loadedRotationState.r4r5Index ?? 0,
                          memberIndex: loadedRotationState.memberIndex ?? 0,
                          skippedVips: loadedRotationState.skippedVips || [],
                          selectedMvps: loadedRotationState.selectedMvps || {},
                          vipCounts: loadedRotationState.vipCounts || {}, // Load counts
                          mvpCounts: loadedRotationState.mvpCounts || {}  // Load counts
                      },
                      previousRotationState: localPreviousState // Restore local undo state
                 };

                // Check if date is missing or invalid after loading
                 if (!state.rotationState.currentDate || isNaN(new Date(state.rotationState.currentDate + 'T00:00:00Z'))) {
                     console.warn("Loaded state missing or has invalid currentDate.");
                     needsDateUpdate = true;
                 }

            } else {
                // Document doesn't exist - Flag for initial setup
                console.log("No state document found in Firestore. Performing initial setup...");
                needsInitialSetup = true;
            }

            // Handle Initial Setup or Date Update
            if (needsInitialSetup || needsDateUpdate) {
                 console.log(`Performing setup: Initial=${needsInitialSetup}, DateUpdate=${needsDateUpdate}`);
                 const today = new Date();
                 const nextMonday = findNextMonday(today);
                 const nextMondayStr = getISODateString(nextMonday);

                 if (needsInitialSetup) {
                      // Set up the entire state with initial defaults
                      state = {
                         members: initialMembers.map(m => ({...m})), // Fresh copy
                         rotationState: {
                             currentDate: nextMondayStr,
                             r4r5Index: 0,
                             memberIndex: 0,
                             skippedVips: [],
                             selectedMvps: {},
                             vipCounts: {},
                             mvpCounts: {}
                         },
                         previousRotationState: null
                      };
                      console.log("Initialized state with defaults, starting date:", nextMondayStr);
                      // Save the newly initialized state back to Firestore immediately
                      updateFirestoreState().catch(err => console.error("Failed to save initial state:", err));
                 } else if (needsDateUpdate) {
                      // Only update the date in the existing state
                      state.rotationState.currentDate = nextMondayStr;
                      console.log("Updating missing/invalid date to:", nextMondayStr);
                      // Save the state with the corrected date
                       updateFirestoreState().catch(err => console.error("Failed to save updated date:", err));
                 }
            }

            console.log("Final local state after Firestore update/init:", JSON.parse(JSON.stringify(state)));

            // Render the UI with the latest state
            render();
            // Ensure admin buttons are re-enabled after state load (if they were disabled by error)
            resetBtn.disabled = false;


        }, (error) => {
            console.error("Error listening to Firestore state:", error);
            alert(`FATAL ERROR: Could not connect to the rotation database (${error.message}).\nCheck connection, Firebase setup (Config & Rules!), and console.\nRefresh to retry.`);
            // Disable critical controls on error
            document.getElementById('vip-actions').style.display = 'none';
             document.getElementById('member-manager').style.pointerEvents = 'none'; // Disable interactions
             document.getElementById('member-manager').style.opacity = '0.5';
             currentDateEl.textContent = "Connection Error";
             resetBtn.disabled = true;
             undoAdvanceBtn.disabled = true;
        });

        // --- Initial Render for Theme ---
        (() => {
             const theme = localStorage.getItem('theme');
             if (theme === 'dark') {
                 document.body.classList.add('dark-mode');
                 themeToggleBtn.textContent = "Toggle Light Mode";
             } else {
                 document.body.classList.remove('dark-mode');
                 themeToggleBtn.textContent = "Toggle Dark Mode";
             }
        })();

    </script>

</body>
</html>