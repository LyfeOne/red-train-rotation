<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[rEd] Train Conductor Rotation - S749 (Shared) - v5</title>
    <style>
        /* --- CSS (leicht erweitert für last-completed und summary) --- */
        :root {
            --bg-color-light: #f4f4f8; --text-color-light: #333; --card-bg-light: #fff; --border-color-light: #ddd; --primary-color-light: #007bff; --primary-text-light: #fff; --accent-color-light: #6c757d; --accent-text-light: #fff; --highlight-bg-light: #e9ecef; --input-bg-light: #fff; --input-border-light: #ccc; --button-hover-light: #0056b3; --remove-btn-light: #dc3545; --remove-btn-hover-light: #c82333; --skipped-bg-light: #fff3cd; --skipped-text-light: #856404; --warning-bg-light: #ffeeba; --warning-text-light: #856404; --warning-border-light: #ffdab1; --last-completed-bg-light: #e2e3e5;

            --bg-color-dark: #22272e; --text-color-dark: #c9d1d9; --card-bg-dark: #2d333b; --border-color-dark: #444c56; --primary-color-dark: #58a6ff; --primary-text-dark: #22272e; --accent-color-dark: #8b949e; --accent-text-dark: #22272e; --highlight-bg-dark: #373e47; --input-bg-dark: #22272e; --input-border-dark: #444c56; --button-hover-dark: #79b8ff; --remove-btn-dark: #f85149; --remove-btn-hover-dark: #da3633; --skipped-bg-dark: #3e3a2e; --skipped-text-dark: #d4a72c; --warning-bg-dark: #4d4124; --warning-text-dark: #ffecb5; --warning-border-dark: #7e6a3c; --last-completed-bg-dark: #30363d;

            /* Default to light mode variables */
            --bg-color: var(--bg-color-light); --text-color: var(--text-color-light); --card-bg: var(--card-bg-light); --border-color: var(--border-color-light); --primary-color: var(--primary-color-light); --primary-text: var(--primary-text-light); --accent-color: var(--accent-color-light); --accent-text: var(--accent-text-light); --highlight-bg: var(--highlight-bg-light); --input-bg: var(--input-bg-light); --input-border: var(--input-border-light); --button-hover: var(--button-hover-light); --remove-btn: var(--remove-btn-light); --remove-btn-hover: var(--remove-btn-hover-light); --skipped-bg: var(--skipped-bg-light); --skipped-text: var(--skipped-text-light); --warning-bg: var(--warning-bg-light); --warning-text: var(--warning-text-light); --warning-border: var(--warning-border-light); --last-completed-bg: var(--last-completed-bg-light);
        }
        body.dark-mode {
            --bg-color: var(--bg-color-dark); --text-color: var(--text-color-dark); --card-bg: var(--card-bg-dark); --border-color: var(--border-color-dark); --primary-color: var(--primary-color-dark); --primary-text: var(--primary-text-dark); --accent-color: var(--accent-color-dark); --accent-text: var(--accent-text-dark); --highlight-bg: var(--highlight-bg-dark); --input-bg: var(--input-bg-dark); --input-border: var(--input-border-dark); --button-hover: var(--button-hover-dark); --remove-btn: var(--remove-btn-dark); --remove-btn-hover: var(--remove-btn-hover-dark); --skipped-bg: var(--skipped-bg-dark); --skipped-text: var(--skipped-text-dark); --warning-bg: var(--warning-bg-dark); --warning-text: var(--warning-text-dark); --warning-border: var(--warning-border-dark); --last-completed-bg: var(--last-completed-bg-dark);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); padding: 15px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 1.8em; color: var(--primary-color); }
        .controls-section, .member-section, .schedule-section, .skipped-section, .stats-section, .admin-section { margin-bottom: 30px; padding: 15px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; }
        h2 { margin-bottom: 15px; color: var(--accent-color); font-size: 1.4em; }
        h3 { margin-bottom: 10px; font-size: 1.2em; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color); }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; margin-right: 5px; margin-bottom: 5px; }
        button:disabled { background-color: var(--accent-color); opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: var(--primary-text); }
        .btn-primary:hover:not(:disabled) { background-color: var(--button-hover); }
        .btn-secondary { background-color: var(--accent-color); color: var(--accent-text); }
        .btn-secondary:hover:not(:disabled) { opacity: 0.9; }
        .btn-remove { background-color: var(--remove-btn); color: var(--primary-text); font-size: 0.8em; padding: 3px 8px; }
        .btn-remove:hover:not(:disabled) { background-color: var(--remove-btn-hover); }
        .btn-vip-action { margin-top: 10px; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 0; border-bottom: 1px dashed var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        li:last-child { border-bottom: none; }
        li span { margin-right: 10px; word-break: break-word; }
        #member-list li .member-info { display: flex; align-items: center; flex-grow: 1; margin-right: 10px; }
        .rank-select-inline { display: inline-block; width: auto; padding: 2px 5px; margin-left: 8px; font-size: 0.9em; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 3px; vertical-align: middle; }
        #schedule-display ul li { display: grid; grid-template-columns: 100px auto auto; gap: 10px; padding: 10px 5px; align-items: start; }
        #schedule-display ul li.current-day { background-color: var(--highlight-bg); font-weight: bold; border-left: 3px solid var(--primary-color); padding-left: 10px; }
        .schedule-date { font-weight: bold; }
        .schedule-vip { font-style: italic; }
        .mvp-selection-required { color: var(--remove-btn); font-weight: bold; }
        #current-day-info { background-color: var(--highlight-bg); padding: 15px; border-radius: 5px; margin-bottom: 0; } /* Removed bottom margin */
        #last-completed-day-info { /* New style */
            margin-top: 0px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color); /* Separator */
            background-color: var(--last-completed-bg); /* Slightly different background */
            font-size: 0.9em;
        }
        #last-completed-day-info p { margin-bottom: 3px; }

        #current-day-info p { margin-bottom: 8px; }
        #mvp-selection-area { display: none; margin: 15px 0; } /* Added margin */
        #mvp-selection-area label { margin-right: 10px; }
        #alternative-vip-area { display: none; margin-top: 20px; padding: 15px; border: 1px solid var(--warning-border); border-radius: 5px; background-color: var(--warning-bg); color: var(--warning-text); }
        #alternative-vip-area label { margin-right: 10px; }
        #alternative-vip-area p { margin-bottom: 10px; font-style: italic; }
        #skipped-vips { padding-top: 10px; }
        #skipped-vips ul li { background-color: var(--skipped-bg); color: var(--skipped-text); padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; border: 1px solid var(--border-color); justify-content: flex-start; font-size: 0.9em;}
        .stats-container { display: flex; flex-wrap: wrap; gap: 20px; }
        #mvp-stats, #vip-stats { flex: 1; min-width: 200px; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); }
        #mvp-stats h3, #vip-stats h3 { font-size: 1.1em; margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        #mvp-stats ul, #vip-stats ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        #mvp-stats li, #vip-stats li { padding: 5px 0; border-bottom: 1px dashed var(--border-color); display: flex; justify-content: space-between; font-size: 0.9em; }
        #mvp-stats li:last-child, #vip-stats li:last-child { border-bottom: none; }
        .stats-count { font-weight: bold; margin-left: 10px; min-width: 20px; text-align: right; }
        .theme-toggle { position: fixed; top: 10px; right: 15px; z-index: 100; }
        .admin-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .admin-section button { margin-right: 10px; }
        /* Details/Summary Styling */
        details > summary { cursor: pointer; font-weight: bold; font-size: 1.2em; margin-bottom: 10px; color: var(--accent-color); }
        details > summary:hover { opacity: 0.8; }
        details[open] > summary { margin-bottom: 15px; } /* More space when open */
        /* --- End Details/Summary Styling --- */
        @media (max-width: 768px) { /* Mobile styles remain the same */ }
        @media (max-width: 480px) { /* Mobile styles remain the same */ }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <button id="theme-toggle" class="theme-toggle btn-secondary">Toggle Dark Mode</button>
    <div class="container">
        <header class="header">
            <h1>[rEd] Dead Redemption - Train Conductor Rotation</h1>
            <p>Server #749 (Shared)</p>
        </header>

        <!-- Current Day and Controls -->
        <section class="controls-section">
            <h2>Today's Status & Actions</h2>
            <div id="current-day">
                 <div id="current-day-info">
                    <p><strong>Date:</strong> <span id="current-date">Loading...</span></p>
                    <p><strong>Day:</strong> <span id="current-day-of-week">---</span></p>
                    <p><strong>Conductor:</strong> <span id="current-conductor">---</span></p>
                    <p><strong>Proposed VIP:</strong> <span id="current-vip">---</span></p>
                </div>
                 <!-- NEW: Last Completed Info -->
                 <div id="last-completed-day-info">
                    <p><strong>Last Completed:</strong> <span id="last-completed-date">---</span></p>
                    <p style="font-size: 0.9em;">Conductor: <span id="last-completed-conductor">---</span>, VIP: <span id="last-completed-vip">---</span></p>
                </div>

                <div id="mvp-selection-area">
                    <label for="mvp-select">Select Today's MVP Conductor:</label>
                    <select id="mvp-select"> <option value="">-- Select MVP --</option> </select>
                </div>

                <div id="vip-actions">
                     <p>Did the proposed VIP accept?</p>
                     <button id="vip-accepted" class="btn-primary btn-vip-action" disabled>Yes, VIP Accepted</button>
                     <button id="vip-skipped" class="btn-secondary btn-vip-action" disabled>No, VIP Skipped</button>
                </div>

                <div id="alternative-vip-area">
                    <p><strong id="original-skipped-vip-name">---</strong> was skipped and added to priority queue.</p>
                    <label for="alternative-vip-select">Select Alternative VIP for Today (Optional):</label>
                    <select id="alternative-vip-select"> <option value="">-- No Alternative VIP --</option> </select>
                    <button id="confirm-alternative-vip" class="btn-primary" style="margin-top: 10px;">Confirm & Advance Day</button>
                </div>

                 <div id="advance-controls" style="margin-top: 15px;">
                    <button id="undo-advance" class="btn-secondary" disabled>Undo Last Advancement</button>
                 </div>
            </div>
        </section>

        <!-- Skipped VIPs Queue -->
        <section class="skipped-section">
             <h2>Skipped VIP Queue (Priority)</h2>
             <div id="skipped-vips">
                 <p>Queue is empty.</p> <ul></ul>
             </div>
        </section>

        <!-- Rotation Schedule -->
        <section class="schedule-section">
             <h2>Upcoming Rotation Schedule</h2>
             <p>Showing the next full cycle of Members receiving VIP.</p>
             <div id="schedule-display"> <ul></ul> </div>
        </section>

        <!-- Member Management (Collapsible) -->
        <section class="member-section">
            <h2>Manage Alliance Members</h2>
            <div id="add-member-form-container">
                 <h3>Add New Member</h3>
                 <form id="add-member-form" class="form-group">
                     <label for="new-member-name">Name:</label> <input type="text" id="new-member-name" required>
                     <label for="new-member-rank">Rank:</label> <select id="new-member-rank"> <option value="Member">Member</option> <option value="R4">R4</option> <option value="R5">R5</option> </select>
                     <button type="submit" class="btn-primary" style="margin-top: 10px;">Add Member</button>
                 </form>
            </div>
            <details id="member-list-details" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <summary> Show/Hide Current Members (<span id="member-count">0</span>) </summary>
                <ul id="member-list"></ul>
            </details>
        </section>

        <!-- Statistics Section -->
        <section class="stats-section">
             <h2>Statistics</h2>
             <div class="stats-container">
                 <div id="mvp-stats"> <h3>MVP Counts</h3> <ul></ul> </div>
                 <div id="vip-stats"> <h3>VIP Counts</h3> <ul></ul> </div>
             </div>
        </section>

        <!-- Admin Controls -->
        <section class="admin-section">
             <h2>Admin</h2>
             <p>Use reset only if absolutely necessary.</p>
             <button id="reset-data" class="btn-remove">Reset All Data to Defaults</button>
        </section>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAT8L9vDqFHyGB-MybtcLEBgCALuNflTZY", // Replace
          authDomain: "red-train-rotation-tool.firebaseapp.com", // Replace
          projectId: "red-train-rotation-tool", // Replace
          storageBucket: "red-train-rotation-tool.firebasestorage.app", // Replace
          messagingSenderId: "178389819926", // Replace
          appId: "1:178389819926:web:bd59c273641ab8530ccb37" // Replace
        };

        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase Init Error", e); alert("Could not initialize Firebase."); }
        const db = firebase.firestore();
        const stateDocRef = db.collection("rotationState").doc("s749_state");

        // --- Constants and State ---
        const MVP_TECH_DAY = 1; const MVP_VS_DAY = 0;
        const RANKS = ["Member", "R4", "R5"];
        let state = { members: [], rotationState: { currentDate: null, r4r5Index: 0, memberIndex: 0, skippedVips: [], selectedMvps: {}, vipCounts: {}, mvpCounts: {} }, previousRotationState: null };
        const initialMembers = [ /* --- Member list remains the same --- */
            { name: "Motherfrogger", rank: "R5"}, { name: "Enyaisrave", rank: "R4"}, { name: "Johcar", rank: "R4"}, { name: "DaVinnie", rank: "R4"}, { name: "CornFlakes", rank: "R4"}, { name: "Lyfe", rank: "R4"}, { name: "LadyLaik", rank: "R4"}, { name: "Pabs64", rank: "R4"}, { name: "Supersebb", rank: "R4"}, { name: "Munky", rank: "R4"}, { name: "NymbleV", rank: "R4"}, { name: "R1/R2/R3 Team", rank: "Member"}, { name: "Smugwell", rank: "Member"}, { name: "MRAN", rank: "Member"}, { name: "Chris", rank: "Member"}, { name: "Leka98", rank: "Member"}, { name: "Darkknight", rank: "Member"}, { name: "Rikkyyyyy", rank: "Member"}, { name: "Gekkegerrittttt", rank: "Member"}, { name: "Ever4", rank: "Member"}, { name: "KFCPov3r", rank: "Member"}, { name: "F L A C", rank: "Member"}, { name: "Jotersan", rank: "Member"}, { name: "Novis01", rank: "Member"}, { name: "Gorkiules", rank: "Member"}, { name: "Jaista", rank: "Member"}, { name: "Megalomanie", rank: "Member"}, { name: "АЛЕКС1980", rank: "Member"}, { name: "TheFloh", rank: "Member"}, { name: "Caretta", rank: "Member"}, { name: "Swisskilla", rank: "Member"}, { name: "Llama deDrama", rank: "Member"}, { name: "oo APACHE oo", rank: "Member"}, { name: "GoFireES", rank: "Member"}, { name: "Foggis", rank: "Member"}, { name: "Paracitus", rank: "Member"}, { name: "IRONHAMMER", rank: "Member"}, { name: "jarako", rank: "Member"}, { name: "Be a wolf", rank: "Member"}, { name: "Commander Blad", rank: "Member"}, { name: "ILYES B", rank: "Member"}, { name: "KingStridez", rank: "Member"}, { name: "diRty freNk", rank: "Member"}, { name: "PavlosP", rank: "Member"}, { name: "Chasseur 777", rank: "Member"}, { name: "Raph911", rank: "Member"}, { name: "B1wizz", rank: "Member"}, { name: "Thirteen Squid", rank: "Member"}, { name: "ЖЭКА", rank: "Member"}, { name: "SkyWinder", rank: "Member"}, { name: "FireXice (Bibot)", rank: "Member"}, { name: "GhósT", rank: "Member"}, { name: "Juantxo79", rank: "Member"}, { name: "Kezual", rank: "Member"}, { name: "Maytos", rank: "Member"}, { name: "jassådu", rank: "Member"}, { name: "Temd", rank: "Member"}, { name: "olabaf", rank: "Member"}, { name: "Faluche", rank: "Member"}, { name: "xPerseus", rank: "Member"}, { name: "Lutonian", rank: "Member"}, { name: "Juggernaut x", rank: "Member"}, { name: "Umbra XIII", rank: "Member"}, { name: "BLÀDE", rank: "Member"}, { name: "koppies", rank: "Member"}, { name: "Cocsi29400", rank: "Member"}, { name: "Nohardfeelz", rank: "Member"}, { name: "Vechniy", rank: "Member"}, { name: "theFoxXx", rank: "Member"}, { name: "S A M U R A i", rank: "Member"}, { name: "Dfyra", rank: "Member"}, { name: "Meloziaa", rank: "Member"}, { name: "Aminos77", rank: "Member"}, { name: "Rev T", rank: "Member"}, { name: "BlackWizardUA", rank: "Member"}, { name: "Bekim1", rank: "Member"}, { name: "Edx777", rank: "Member"}, { name: "Laeta", rank: "Member"}, { name: "Kyuchie", rank: "Member"}, { name: "depechefann", rank: "Member"}, { name: "BlackPush", rank: "Member"}, { name: "Gunnovic", rank: "Member"}, { name: "NinoDelBono", rank: "Member"}, { name: "Dario217", rank: "Member"}
         ].map(m => ({ ...m, id: generateId() }));

        // --- DOM Elements ---
        const memberListEl = document.getElementById('member-list'); const addMemberForm = document.getElementById('add-member-form'); const newMemberNameInput = document.getElementById('new-member-name'); const newMemberRankSelect = document.getElementById('new-member-rank'); const memberCountEl = document.getElementById('member-count'); const currentDateEl = document.getElementById('current-date'); const currentDayOfWeekEl = document.getElementById('current-day-of-week'); const currentConductorEl = document.getElementById('current-conductor'); const currentVipEl = document.getElementById('current-vip'); const skippedVipsListEl = document.getElementById('skipped-vips').querySelector('ul'); const scheduleDisplayListEl = document.getElementById('schedule-display').querySelector('ul'); const vipAcceptedBtn = document.getElementById('vip-accepted'); const vipSkippedBtn = document.getElementById('vip-skipped'); const undoAdvanceBtn = document.getElementById('undo-advance'); const mvpSelectionArea = document.getElementById('mvp-selection-area'); const mvpSelect = document.getElementById('mvp-select'); const themeToggleBtn = document.getElementById('theme-toggle'); const resetBtn = document.getElementById('reset-data'); const mvpStatsListEl = document.getElementById('mvp-stats').querySelector('ul'); const vipStatsListEl = document.getElementById('vip-stats').querySelector('ul');
        const alternativeVipArea = document.getElementById('alternative-vip-area'); const alternativeVipSelect = document.getElementById('alternative-vip-select'); const confirmAlternativeVipBtn = document.getElementById('confirm-alternative-vip'); const originalSkippedVipNameEl = document.getElementById('original-skipped-vip-name');
        // New Elements for Last Completed Day
        const lastCompletedDateEl = document.getElementById('last-completed-date');
        const lastCompletedConductorEl = document.getElementById('last-completed-conductor');
        const lastCompletedVipEl = document.getElementById('last-completed-vip');


        // --- Utility Functions ---
        function generateId() { return Math.random().toString(36).substring(2, 15); }
        function getDayOfWeek(date) { return date.getDay(); }
        function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return "Invalid Date"; return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }); }
        function getISODateString(date) { if (!(date instanceof Date) || isNaN(date)) { console.error("Invalid date:", date); return new Date().toISOString().split('T')[0]; } return date.toISOString().split('T')[0]; }
        function addDays(date, days) { const result = new Date(date); result.setDate(result.getDate() + days); return result; }
        function findNextMonday(date) { const d = getDayOfWeek(date); const diff = (8 - d) % 7; return addDays(date, diff === 0 ? 7 : diff); }
        function getMemberById(id) { return state.members?.find(m => m?.id === id); }
        function getMembersByRank(rank) { if (!Array.isArray(state.members)) return []; if (rank === 'R4/R5') return state.members.filter(m => m && (m.rank === 'R4' || m.rank === 'R5')); return state.members.filter(m => m && m.rank === rank); }

        // --- Core Logic ---
        function calculateDailyAssignments(targetDateStr, currentR4R5Index, currentMemberIndex, currentSkippedVips, selectedMvpsMap) { /* --- Unchanged --- */
            if (!targetDateStr || typeof currentR4R5Index !== 'number' || typeof currentMemberIndex !== 'number' || !Array.isArray(currentSkippedVips) || typeof selectedMvpsMap !== 'object') { console.error("Invalid params"); return { date: new Date(), conductor: { id: 'ERR', name: 'Error' }, vip: { id: 'ERR', name: 'Error'} }; }
            const targetDate = new Date(targetDateStr + 'T00:00:00Z'); if (isNaN(targetDate)) { console.error("Invalid date"); return { date: new Date(), conductor: { id: 'ERR', name: 'Error' }, vip: { id: 'ERR', name: 'Error'} }; }
            const dayOfWeek = getDayOfWeek(targetDate); let conductor = null; let vip = null;
            const r4r5Members = getMembersByRank('R4/R5'); const memberMembers = getMembersByRank('Member');
            if (dayOfWeek === MVP_TECH_DAY) { const k = `${targetDateStr}_Mon`; const id = selectedMvpsMap[k]; conductor = id ? getMemberById(id) : { id: 'MVP_MON_SELECT', name: 'Tech MVP Needed', rank: 'MVP' }; }
            else if (dayOfWeek === MVP_VS_DAY) { const k = `${targetDateStr}_Sun`; const id = selectedMvpsMap[k]; conductor = id ? getMemberById(id) : { id: 'MVP_SUN_SELECT', name: 'VS MVP Needed', rank: 'MVP' }; }
            else { conductor = r4r5Members.length > 0 ? r4r5Members[currentR4R5Index % r4r5Members.length] : { id: 'NO_R4R5', name: 'No R4/R5', rank: 'Sys' }; }
            const validSkipped = currentSkippedVips.filter(id => getMemberById(id));
            if (validSkipped.length > 0) { vip = getMemberById(validSkipped[0]); }
            else if (memberMembers.length > 0) { vip = memberMembers[currentMemberIndex % memberMembers.length]; }
            else { vip = { id: 'NO_MEMBERS', name: 'No Members', rank: 'Sys' }; }
            conductor = conductor || { id: 'ERR_C', name: 'Err C', rank: 'Sys' }; vip = vip || { id: 'ERR_V', name: 'Err V', rank: 'Sys' };
            return { date: targetDate, conductor, vip };
        }
        function advanceRotation(vipAccepted, selectedMvpId = null) { /* --- Mostly Unchanged - Handles ACCEPT path --- */
            console.log(`ADVANCE ROTATION (ACCEPT PATH): mvpId=${selectedMvpId}`);
            if (!state.rotationState?.currentDate) { console.error("Cannot advance: state missing"); return false; }
            const currentDateStr = state.rotationState.currentDate; const currentDate = new Date(currentDateStr + 'T00:00:00Z'); const currentDayOfWeek = getDayOfWeek(currentDate);
            const currentR4R5Index = state.rotationState.r4r5Index ?? 0; const currentMemberIndex = state.rotationState.memberIndex ?? 0;
            const currentSkippedVips = [...(state.rotationState.skippedVips || [])]; const currentVipCounts = { ...(state.rotationState.vipCounts || {}) }; const currentMvpCounts = { ...(state.rotationState.mvpCounts || {}) }; const currentSelectedMvps = { ...(state.rotationState.selectedMvps || {}) };
            const { vip: proposedVip } = calculateDailyAssignments(currentDateStr, currentR4R5Index, currentMemberIndex, currentSkippedVips, currentSelectedMvps);
            if (!proposedVip?.id || proposedVip.id.startsWith('NO_') || proposedVip.id.startsWith('ERROR_')) { console.warn("Cannot advance: No valid VIP"); alert("No valid VIP proposed."); return false; }
            const proposedVipId = proposedVip.id; let nextR4R5Index = currentR4R5Index; let nextMemberIndex = currentMemberIndex; let nextSkippedVips = currentSkippedVips.filter(id => getMemberById(id));
            const wasVipFromSkippedList = nextSkippedVips.length > 0 && nextSkippedVips[0] === proposedVipId;

            // Only process if vipAccepted is true
            if (!vipAccepted) { console.error("advanceRotation called incorrectly for skip path."); return false; }

            if (wasVipFromSkippedList) { nextSkippedVips.shift(); } else { nextMemberIndex = (currentMemberIndex + 1); }
            currentVipCounts[proposedVipId] = (currentVipCounts[proposedVipId] || 0) + 1; console.log(`VIP Count Inc: ${proposedVip.name} -> ${currentVipCounts[proposedVipId]}`);

            if (currentDayOfWeek >= 2 && currentDayOfWeek <= 6) { nextR4R5Index = (currentR4R5Index + 1); }
            if (selectedMvpId) { const member = getMemberById(selectedMvpId); if (member) { const mvpKey = currentDayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`; currentSelectedMvps[mvpKey] = selectedMvpId; currentMvpCounts[selectedMvpId] = (currentMvpCounts[selectedMvpId] || 0) + 1; console.log(`MVP Count Inc: ${member.name} -> ${currentMvpCounts[selectedMvpId]}`); } else { console.warn(`MVP ID ${selectedMvpId} not found`); } }
            const nextDate = addDays(currentDate, 1); const nextDateStr = getISODateString(nextDate);
            state.rotationState.currentDate = nextDateStr; state.rotationState.r4r5Index = nextR4R5Index; state.rotationState.memberIndex = nextMemberIndex; state.rotationState.skippedVips = nextSkippedVips; state.rotationState.selectedMvps = currentSelectedMvps; state.rotationState.vipCounts = currentVipCounts; state.rotationState.mvpCounts = currentMvpCounts;
            console.log("Advance Rotation ACCEPT successful. New state (local):", JSON.parse(JSON.stringify(state.rotationState)));
            return true;
        }
        function updateFirestoreState() { /* --- Unchanged --- */
            const stateToSave={members:state.members||[], rotationState:{currentDate:state.rotationState.currentDate, r4r5Index:state.rotationState.r4r5Index??0, memberIndex:state.rotationState.memberIndex??0, skippedVips:state.rotationState.skippedVips||[], selectedMvps:state.rotationState.selectedMvps||{}, vipCounts:state.rotationState.vipCounts||{}, mvpCounts:state.rotationState.mvpCounts||{}}}; console.log("Attempting FS write:", JSON.parse(JSON.stringify(stateToSave))); return stateDocRef.set(stateToSave).then(()=>{console.log("FS write OK");}).catch((e)=>{console.error("FS write FAIL:", e); alert(`Save Error: ${e.message}`); throw e;});
        }

        // --- Member Management ---
        function addMember(event) { /* --- Unchanged --- */ event.preventDefault(); const n = newMemberNameInput.value.trim(); const r = newMemberRankSelect.value; if(n&&r){ if(!Array.isArray(state.members)) state.members=[]; if(state.members.some(m=>m?.name.toLowerCase()===n.toLowerCase())){alert(`Exists: ${n}`); return;} const nm={id:generateId(), name:n, rank:r}; state.members.push(nm); sortMembers(); updateFirestoreState(); newMemberNameInput.value='';} else{alert("Name & Rank needed");} }
        function removeMember(id) { /* --- Unchanged --- */ const m=getMemberById(id); if(!m) return; if(confirm(`Remove ${m.name}?`)){if(!Array.isArray(state.members)) state.members=[]; state.members=state.members.filter(mb=>mb?.id !== id); if(!state.rotationState) state.rotationState={}; if(!Array.isArray(state.rotationState.skippedVips)) state.rotationState.skippedVips=[]; state.rotationState.skippedVips = state.rotationState.skippedVips.filter(sid => sid !== id); updateFirestoreState();} }
        function handleRankChange(event) { /* --- Unchanged --- */ const sel = event.target; const id = sel.dataset.memberId; const rank = sel.value; const idx = state.members.findIndex(m => m?.id === id); if(idx === -1) { console.error("Not found:", id); return; } const name = state.members[idx].name; if(state.members[idx].rank === rank) return; if(confirm(`Change ${name} rank to ${rank}?`)){ state.members[idx].rank = rank; console.log(`Rank Change: ${name} -> ${rank}`); sortMembers(); updateFirestoreState(); } else { sel.value = state.members[idx].rank; } }
        function sortMembers() { /* --- Unchanged --- */ if(!Array.isArray(state.members)) return; const order = {'R5':1, 'R4':2, 'Member':3}; state.members.sort((a,b) => { const rA=a?.rank; const rB=b?.rank; const nA=a?.name||""; const nB=b?.name||""; const d=(order[rA]||99)-(order[rB]||99); if(d!==0) return d; return nA.localeCompare(nB); }); }

        // --- Rendering Functions ---
        function renderMemberList() { /* --- Unchanged --- */ memberListEl.innerHTML = ''; if (!Array.isArray(state.members)) { return; } memberCountEl.textContent = state.members.length; sortMembers(); if (state.members.length === 0) { memberListEl.innerHTML = '<li>No members.</li>'; return; } state.members.forEach(member => { if (!member?.id || !member.name || !member.rank) return; const li=document.createElement('li'); li.dataset.memberId = member.id; const info=document.createElement('div'); info.classList.add('member-info'); const nameS=document.createElement('span'); nameS.textContent = member.name; info.appendChild(nameS); const rankS=document.createElement('select'); rankS.classList.add('rank-select-inline'); rankS.dataset.memberId = member.id; RANKS.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; if(member.rank===r) o.selected=true; rankS.appendChild(o); }); rankS.addEventListener('change', handleRankChange); info.appendChild(rankS); const acts=document.createElement('div'); acts.classList.add('member-actions'); const remB=document.createElement('button'); remB.textContent='Remove'; remB.classList.add('btn-remove'); remB.onclick=()=>removeMember(member.id); acts.appendChild(remB); li.appendChild(info); li.appendChild(acts); memberListEl.appendChild(li); }); }
        function renderCurrentDay() { // Updated to handle displaying selected MVP and hide alt VIP area
            if (!state.rotationState?.currentDate) { /* Handle uninitialized */ return; }
            const currentDateStr = state.rotationState.currentDate; const currentDate = new Date(currentDateStr + 'T00:00:00Z'); if (isNaN(currentDate)) { currentDateEl.textContent = "Invalid Date!"; return; }
            const dayOfWeek = getDayOfWeek(currentDate); const safeSelectedMvps = state.rotationState.selectedMvps || {}; const safeSkippedVips = state.rotationState.skippedVips || [];
            const { conductor: calculatedConductor, vip } = calculateDailyAssignments(currentDateStr, state.rotationState.r4r5Index ?? 0, state.rotationState.memberIndex ?? 0, safeSkippedVips, safeSelectedMvps);
            if (!calculatedConductor || !vip || calculatedConductor.id?.startsWith('ERR')) { /* Handle error */ return; }
            currentDateEl.textContent = formatDate(currentDate); currentDayOfWeekEl.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            let finalConductor = calculatedConductor; let isMvpSelectionNeeded = false; const mvpKey = dayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`;
            if (dayOfWeek === MVP_TECH_DAY || dayOfWeek === MVP_VS_DAY) { const selectedMvpId = safeSelectedMvps[mvpKey]; if (selectedMvpId) { const storedMvp = getMemberById(selectedMvpId); if (storedMvp) { finalConductor = storedMvp; currentConductorEl.textContent = `${finalConductor.name} (${finalConductor.rank})`; mvpSelectionArea.style.display = 'none'; isMvpSelectionNeeded = false; } else { currentConductorEl.textContent = `Stored MVP (ID: ${selectedMvpId}) not found!`; mvpSelectionArea.style.display = 'none'; isMvpSelectionNeeded = false; } } else { currentConductorEl.innerHTML = `<span class="mvp-selection-required">${calculatedConductor.name}</span>`; populateMvpSelect(); mvpSelectionArea.style.display = 'block'; mvpSelect.value = ""; isMvpSelectionNeeded = true; } }
            else { currentConductorEl.textContent = `${finalConductor.name} (${finalConductor.rank})`; mvpSelectionArea.style.display = 'none'; isMvpSelectionNeeded = false; }
            const vipName = vip.name || "Unknown"; const vipRank = vip.rank || "N/A"; let isVipActionPossible = false;
            if (vip.id === 'NO_MEMBERS' || vip.id.startsWith('ERR')) { currentVipEl.textContent = vipName; document.getElementById('vip-actions').style.display = 'none'; }
            else { currentVipEl.textContent = `${vipName} (${vipRank})`; document.getElementById('vip-actions').style.display = 'block'; isVipActionPossible = true; }
            alternativeVipArea.style.display = 'none'; // Ensure hidden on normal render
            vipAcceptedBtn.disabled = !isVipActionPossible || isMvpSelectionNeeded; vipSkippedBtn.disabled = !isVipActionPossible || isMvpSelectionNeeded;
            undoAdvanceBtn.disabled = !state.previousRotationState;
        }
        function populateMvpSelect() { /* --- Unchanged --- */ mvpSelect.innerHTML = '<option value="">-- Select MVP --</option>'; if (!Array.isArray(state.members)) return; state.members.forEach(m => { if (!m?.id) return; const o=document.createElement('option'); o.value=m.id; o.textContent=`${m.name} (${m.rank})`; mvpSelect.appendChild(o); }); }
        function renderSkippedVips() { /* --- Unchanged --- */ skippedVipsListEl.innerHTML = ''; const container = document.getElementById('skipped-vips'); if (!state.rotationState?.skippedVips) { container.querySelector('p').textContent = 'Error loading list.'; return; } const valid = state.rotationState.skippedVips.filter(id => getMemberById(id)); if (valid.length === 0) { container.querySelector('p').textContent = 'Queue is empty.'; return; } container.querySelector('p').textContent = ''; valid.forEach(id => { const m = getMemberById(id); if(m){const li = document.createElement('li'); li.textContent = `${m.name} (${m.rank})`; skippedVipsListEl.appendChild(li);} }); }
        function renderSchedule() { /* --- Unchanged --- */ scheduleDisplayListEl.innerHTML = ''; if (!state.rotationState?.currentDate || !state.members) { scheduleDisplayListEl.innerHTML = '<li>Not ready</li>'; return; } const members = getMembersByRank('Member'); if (members.length === 0) { scheduleDisplayListEl.innerHTML = '<li>No Members</li>'; return; } const skipped = (state.rotationState.skippedVips || []).filter(id => getMemberById(id)); const len = Math.max(7, members.length + skipped.length); let date = new Date(state.rotationState.currentDate + 'T00:00:00Z'); let r4r5Idx = state.rotationState.r4r5Index ?? 0; let memIdx = state.rotationState.memberIndex ?? 0; let tempSkipped = [...skipped]; let tempMvps = JSON.parse(JSON.stringify(state.rotationState.selectedMvps || {})); for (let i = 0; i < len; i++) { if (isNaN(date)) break; const dateStr = getISODateString(date); const day = getDayOfWeek(date); const { conductor, vip } = calculateDailyAssignments(dateStr, r4r5Idx, memIdx, tempSkipped, tempMvps); if (conductor.id?.startsWith('ERR') || vip.id?.startsWith('ERR')) { console.warn(`Sched Err ${dateStr}`); } else { const li = document.createElement('li'); if (i === 0) li.classList.add('current-day'); const dS = document.createElement('span'); dS.classList.add('schedule-date'); dS.textContent = formatDate(date); const cS = document.createElement('span'); cS.classList.add('schedule-conductor'); const cN = conductor.name || "?"; const cR = conductor.rank || "N/A"; if (conductor.id === 'MVP_MON_SELECT' || conductor.id === 'MVP_SUN_SELECT') { const k = day === MVP_TECH_DAY ? `${dateStr}_Mon` : `${dateStr}_Sun`; if (tempMvps[k]) { const mvp = getMemberById(tempMvps[k]); cS.textContent = `C: ${mvp?.name || '?'} (MVP)`; } else { cS.innerHTML = `<span class="mvp-selection-required">${cN}</span>`; } } else { cS.textContent = `C: ${cN} (${cR})`; } const vS = document.createElement('span'); vS.classList.add('schedule-vip'); const vN = vip.name || "?"; const vR = vip.rank || "N/A"; if (vip.id === 'NO_MEMBERS' || vip.id.startsWith('ERR')) { vS.textContent = vN; } else { vS.textContent = `VIP: ${vN} (${vR})`; if (tempSkipped.length > 0 && tempSkipped[0] === vip.id) vS.textContent += ' (Skipped)'; } li.appendChild(dS); li.appendChild(cS); li.appendChild(vS); scheduleDisplayListEl.appendChild(li); } if (vip.id && !vip.id.startsWith('NO_') && !vip.id.startsWith('ERR')) { const wasSkipped = tempSkipped.length > 0 && tempSkipped[0] === vip.id; if (wasSkipped) { tempSkipped.shift(); } else { memIdx = (memIdx + 1); } } if (day >= 2 && day <= 6) { r4r5Idx = (r4r5Idx + 1); } date = addDays(date, 1); } }
        function renderStatistics() { /* --- Unchanged --- */ mvpStatsListEl.innerHTML = ''; vipStatsListEl.innerHTML = ''; if (!state.members?.length) { mvpStatsListEl.innerHTML = '<li>No members</li>'; vipStatsListEl.innerHTML = '<li>No members</li>'; return; } const mvpC = state.rotationState.mvpCounts || {}; const vipC = state.rotationState.vipCounts || {}; const sorted = [...state.members].sort((a, b) => (a?.name || "").localeCompare(b?.name || "")); let hasMvp = false; sorted.forEach(m => { if (!m?.id || !m.name) return; const c = mvpC[m.id] || 0; if (c > 0) hasMvp = true; const li = document.createElement('li'); li.textContent = m.name; const s = document.createElement('span'); s.classList.add('stats-count'); s.textContent = c; li.appendChild(s); mvpStatsListEl.appendChild(li); }); if (!hasMvp && sorted.length > 0) mvpStatsListEl.innerHTML = '<li>No MVPs yet.</li>'; let hasVip = false; sorted.forEach(m => { if (!m?.id || !m.name) return; const c = vipC[m.id] || 0; if (c > 0) hasVip = true; const li = document.createElement('li'); li.textContent = m.name; const s = document.createElement('span'); s.classList.add('stats-count'); s.textContent = c; li.appendChild(s); vipStatsListEl.appendChild(li); }); if (!hasVip && sorted.length > 0) vipStatsListEl.innerHTML = '<li>No VIPs yet.</li>'; if (sorted.length === 0) { mvpStatsListEl.innerHTML = '<li>No members</li>'; vipStatsListEl.innerHTML = '<li>No members</li>'; } }
        // New Function to render last completed day
        function renderLastCompletedDay() {
            lastCompletedDateEl.textContent = "---"; lastCompletedConductorEl.textContent = "---"; lastCompletedVipEl.textContent = "---";
            if (!state.rotationState?.currentDate || !state.previousRotationState?.currentDate) return; // Need previous state

            const lastDateStr = state.previousRotationState.currentDate;
            const lastDate = new Date(lastDateStr + 'T00:00:00Z');
            if (isNaN(lastDate)) return;
            const lastDayOfWeek = getDayOfWeek(lastDate);
            const lastR4R5Index = state.previousRotationState.r4r5Index ?? 0; const lastMemberIndex = state.previousRotationState.memberIndex ?? 0; const lastSkippedVips = state.previousRotationState.skippedVips || [];
            const currentSelectedMvps = state.rotationState.selectedMvps || {}; // Use current MVP map

            lastCompletedDateEl.textContent = formatDate(lastDate);

            // Determine Conductor
            let conductorName = "---";
            if (lastDayOfWeek === MVP_TECH_DAY || lastDayOfWeek === MVP_VS_DAY) {
                const mvpKey = lastDayOfWeek === MVP_TECH_DAY ? `${lastDateStr}_Mon` : `${lastDateStr}_Sun`;
                const selectedMvpId = currentSelectedMvps[mvpKey];
                if (selectedMvpId) { const mvp = getMemberById(selectedMvpId); conductorName = mvp ? `${mvp.name} (MVP)` : `Selected MVP (ID: ${selectedMvpId})`; }
                else { conductorName = "(MVP not recorded?)"; }
            } else { const r4r5 = getMembersByRank('R4/R5'); if (r4r5.length > 0) { const c = r4r5[lastR4R5Index % r4r5.length]; conductorName = c ? `${c.name} (${c.rank})` : "Error R4/R5"; } else { conductorName = "No R4/R5"; } }
            lastCompletedConductorEl.textContent = conductorName;

            // Determine proposed VIP and if they were skipped
            const { vip: proposedVip } = calculateDailyAssignments(lastDateStr, lastR4R5Index, lastMemberIndex, lastSkippedVips, {}); // selectedMvps map irrelevant for VIP proposal
            if (proposedVip?.id && !proposedVip.id.startsWith('NO_') && !proposedVip.id.startsWith('ERROR_')) {
                const currentSkipped = state.rotationState.skippedVips || [];
                // Check if the proposed VIP is now the *first* in the *current* skipped list AND wasn't in the *previous* skipped list
                 const wasJustSkipped = currentSkipped[0] === proposedVip.id && !lastSkippedVips.includes(proposedVip.id);
                 lastCompletedVipEl.textContent = `${proposedVip.name} (${proposedVip.rank})${wasJustSkipped ? ' (Skipped)' : ' (Accepted)'}`;
             } else { lastCompletedVipEl.textContent = proposedVip?.name || "---"; }
        }
        function render() { /* Calls new renderLastCompletedDay */
            console.log("Rendering UI...");
            const theme = localStorage.getItem('theme'); if (theme === 'dark') { document.body.classList.add('dark-mode'); themeToggleBtn.textContent = "Toggle Light Mode"; } else { document.body.classList.remove('dark-mode'); themeToggleBtn.textContent = "Toggle Dark Mode"; }
            renderMemberList(); renderSkippedVips(); renderCurrentDay(); renderSchedule(); renderStatistics();
            renderLastCompletedDay(); // <-- Call the new render function
            undoAdvanceBtn.disabled = !state.previousRotationState;
        }

        // --- New/Updated Functions ---
        function handleMvpDropdownChange() { /* --- Unchanged --- */ if (mvpSelectionArea.style.display === 'block') { const selVal = mvpSelect.value; const enable = selVal !== ""; console.log(`MVP Dropdown changed. Val: "${selVal}". Enable: ${enable}`); const vipEl = document.getElementById('current-vip'); const vipTxt = vipEl ? vipEl.textContent : ""; const vipOK = !(vipTxt.includes("No Members") || vipTxt.includes("Error")); vipAcceptedBtn.disabled = !enable || !vipOK; vipSkippedBtn.disabled = !enable || !vipOK; } else { vipAcceptedBtn.disabled = true; vipSkippedBtn.disabled = true; } }
        function populateAlternativeVipSelect() { /* --- Unchanged --- */ alternativeVipSelect.innerHTML = '<option value="">-- No Alternative VIP --</option>'; const members = getMembersByRank('Member'); members.forEach(m => { if (!m?.id) return; const o = document.createElement('option'); o.value = m.id; o.textContent = `${m.name} (${m.rank})`; alternativeVipSelect.appendChild(o); }); }
        async function handleConfirmAlternativeVip() { // Updated to handle MVP count
             console.log("--- handleConfirmAlternativeVip START ---");
             const alternativeVipId = alternativeVipSelect.value;
             const originallySkippedVipId = alternativeVipArea.dataset.originalVipId;
             const selectedMvpIdForToday = alternativeVipArea.dataset.selectedMvpId; // <-- Read potential MVP ID

             if (!originallySkippedVipId) { console.error("Original skipped VIP ID missing!"); return; }

             confirmAlternativeVipBtn.disabled = true; alternativeVipSelect.disabled = true; undoAdvanceBtn.disabled = true;

             const currentDateStr = state.rotationState.currentDate; const currentDate = new Date(currentDateStr + 'T00:00:00Z'); const currentDayOfWeek = getDayOfWeek(currentDate);
             const currentR4R5Index = state.rotationState.r4r5Index ?? 0; const currentMemberIndex = state.rotationState.memberIndex ?? 0;
             const currentSkippedVips = [...(state.rotationState.skippedVips || [])].filter(id => getMemberById(id));
             const currentSelectedMvps = { ...(state.rotationState.selectedMvps || {}) }; const currentVipCounts = { ...(state.rotationState.vipCounts || {}) };
             const currentMvpCounts = { ...(state.rotationState.mvpCounts || {}) }; // Get current MVP counts

             // Add original VIP to skipped list if not already there
             if (!currentSkippedVips.includes(originallySkippedVipId)) { currentSkippedVips.unshift(originallySkippedVipId); }

             // Increment MVP count if one was selected for today
             if (selectedMvpIdForToday) {
                 const member = getMemberById(selectedMvpIdForToday);
                 if (member) {
                     currentMvpCounts[selectedMvpIdForToday] = (currentMvpCounts[selectedMvpIdForToday] || 0) + 1;
                     console.log(`ConfirmAltVIP: MVP Count Inc: ${member.name} -> ${currentMvpCounts[selectedMvpIdForToday]}`);
                 } else { console.warn(`ConfirmAltVIP: MVP ID ${selectedMvpIdForToday} not found`); }
             }

             let nextR4R5Index = currentR4R5Index; if (currentDayOfWeek >= 2 && currentDayOfWeek <= 6) { nextR4R5Index = (currentR4R5Index + 1); }
             const nextDate = addDays(currentDate, 1); const nextDateStr = getISODateString(nextDate);

             try { state.previousRotationState = JSON.parse(JSON.stringify(state.rotationState)); console.log("Stored undo state."); } catch (e) { console.error("Undo store error:", e); state.previousRotationState = null; }

             // Update local state
             state.rotationState.currentDate = nextDateStr; state.rotationState.r4r5Index = nextR4R5Index; state.rotationState.memberIndex = currentMemberIndex; // Keep same Member index
             state.rotationState.skippedVips = currentSkippedVips; state.rotationState.selectedMvps = currentSelectedMvps; state.rotationState.vipCounts = currentVipCounts; // No VIP count change
             state.rotationState.mvpCounts = currentMvpCounts; // Set updated MVP counts

             console.log("Advancing day after skip. New local state:", JSON.parse(JSON.stringify(state.rotationState)));

             try { await updateFirestoreState(); console.log("FS updated after alt VIP."); alternativeVipArea.style.display = 'none'; }
             catch (error) { console.error("Save fail after alt VIP:", error); alert("Error saving. Check console."); confirmAlternativeVipBtn.disabled = false; alternativeVipSelect.disabled = false; }
             console.log("--- handleConfirmAlternativeVip END ---");
        }

        // --- Event Listeners ---
        addMemberForm.addEventListener('submit', addMember);

        vipAcceptedBtn.addEventListener('click', () => handleVipAction(true));
        console.log("DEBUG: Listener vipAcceptedBtn OK");
        vipSkippedBtn.addEventListener('click', () => handleVipAction(false));
        console.log("DEBUG: Listener vipSkippedBtn OK");

        mvpSelect.addEventListener('change', handleMvpDropdownChange);
        console.log("DEBUG: Listener mvpSelect OK");

        confirmAlternativeVipBtn.addEventListener('click', handleConfirmAlternativeVip);
        console.log("DEBUG: Listener confirmAlternativeVipBtn OK");

        async function handleVipAction(accepted) { // Heavily modified for skip path
            console.log(`--- handleVipAction START --- Accepted: ${accepted}`);
            if (!state.rotationState?.currentDate) { alert("State not loaded"); return; }
            const currentDateStr = state.rotationState.currentDate; const currentDate = new Date(currentDateStr + 'T00:00:00Z'); const dayOfWeek = getDayOfWeek(currentDate);
            let selectedMvpId = null; // This will hold the ID if an MVP is selected *in this interaction*
            if (dayOfWeek === MVP_TECH_DAY || dayOfWeek === MVP_VS_DAY) { const mvpKey = dayOfWeek === MVP_TECH_DAY ? `${currentDateStr}_Mon` : `${currentDateStr}_Sun`; const existingMvp = state.rotationState.selectedMvps?.[mvpKey]; if (!existingMvp) { selectedMvpId = mvpSelect.value; if (!selectedMvpId) { alert("Select MVP"); return; } } else { console.log("MVP already selected"); selectedMvpId = existingMvp; /* Use existing if already set */ } }

             vipAcceptedBtn.disabled = true; vipSkippedBtn.disabled = true; undoAdvanceBtn.disabled = true;
             alternativeVipArea.style.display = 'none';

            if (accepted) {
                // --- ACCEPT PATH ---
                try { state.previousRotationState = JSON.parse(JSON.stringify(state.rotationState)); console.log("Stored prev state for undo."); } catch (e) { console.error("Undo store error:", e); state.previousRotationState = null; }
                console.log(`handleVipAction(Accept): MVP ID to pass: ${selectedMvpId}`);
                const success = advanceRotation(true, selectedMvpId); // Pass true for accepted
                if (success) {
                    console.log("handleVipAction(Accept): Saving state...");
                    try { await updateFirestoreState(); undoAdvanceBtn.disabled = !state.previousRotationState; console.log("handleVipAction(Accept): Save OK"); }
                    catch (error) { console.error("handleVipAction(Accept): Save FAIL:", error); alert("Error saving. Check console!"); renderCurrentDay(); }
                } else { console.warn("handleVipAction(Accept): advanceRotation failed"); renderCurrentDay(); }
            } else {
                // --- SKIP PATH ---
                console.log("handleVipAction(Skip): Showing alternative VIP selection.");
                const { vip: proposedVip } = calculateDailyAssignments( currentDateStr, state.rotationState.r4r5Index ?? 0, state.rotationState.memberIndex ?? 0, state.rotationState.skippedVips || [], state.rotationState.selectedMvps || {} );
                if (!proposedVip?.id || proposedVip.id.startsWith('NO_') || proposedVip.id.startsWith('ERROR_')) { alert("Cannot process skip: No valid VIP was proposed."); renderCurrentDay(); return; }
                alternativeVipArea.dataset.originalVipId = proposedVip.id;
                alternativeVipArea.dataset.selectedMvpId = selectedMvpId || ""; // Store MVP ID selected NOW
                originalSkippedVipNameEl.textContent = proposedVip.name || "The proposed VIP";
                populateAlternativeVipSelect(); alternativeVipArea.style.display = 'block';
                confirmAlternativeVipBtn.disabled = false; alternativeVipSelect.disabled = false;
            }
            console.log("--- handleVipAction END ---");
        }

        undoAdvanceBtn.addEventListener('click', async () => { /* --- Unchanged --- */ if (!state.previousRotationState) { alert("No undo state."); return; } if (confirm("Undo last advancement?")) { undoAdvanceBtn.disabled = true; try { if (typeof state.previousRotationState !== 'object' || state.previousRotationState === null) { throw new Error("Invalid undo data."); } state.rotationState = JSON.parse(JSON.stringify(state.previousRotationState)); state.previousRotationState = null; console.log("Rolled back state:", JSON.parse(JSON.stringify(state.rotationState))); await updateFirestoreState(); console.log("FS updated after undo."); } catch (error) { console.error("Undo error:", error); alert("Undo error: " + error.message); } } });
        console.log("DEBUG: Listener undoAdvanceBtn OK");

        themeToggleBtn.addEventListener('click', () => { /* --- Unchanged --- */ document.body.classList.toggle('dark-mode'); if (document.body.classList.contains('dark-mode')) { localStorage.setItem('theme', 'dark'); themeToggleBtn.textContent = "Toggle Light Mode"; } else { localStorage.setItem('theme', 'light'); themeToggleBtn.textContent = "Toggle Dark Mode"; } });
        console.log("DEBUG: Listener themeToggleBtn OK");

        resetBtn.addEventListener('click', async () => { /* --- Unchanged --- */ if (confirm("!! WARNING !! Reset ALL data?")) { console.warn("Resetting data!"); resetBtn.disabled = true; const today = new Date(); const nextM = findNextMonday(today); const nextMStr = getISODateString(nextM); state.members = initialMembers.map(m => ({...m})); state.rotationState = { currentDate: nextMStr, r4r5Index: 0, memberIndex: 0, skippedVips: [], selectedMvps: {}, vipCounts: {}, mvpCounts: {} }; state.previousRotationState = null; try { await updateFirestoreState(); console.log("FS reset OK."); alert("Data reset."); } catch (error) { console.error("Reset error:", error); alert("Reset error."); resetBtn.disabled = false; } } });
        console.log("DEBUG: Listener resetBtn OK");

        // --- Initialization and Realtime Updates ---
        stateDocRef.onSnapshot((doc) => { /* --- Unchanged --- */ console.log("FS data received/updated."); let needsInitialSetup=false; let needsDateUpdate=false; if(doc.exists){ const data=doc.data(); console.log("Raw FS data:",data); const localPrev=state.previousRotationState; const loadedMembers=(data.members||[]).map(m=>({...m, id: m.id||generateId()})); const loadedRotState=data.rotationState||{}; state={ members:loadedMembers, rotationState:{ currentDate:loadedRotState.currentDate||null, r4r5Index:loadedRotState.r4r5Index??0, memberIndex:loadedRotState.memberIndex??0, skippedVips:loadedRotState.skippedVips||[], selectedMvps:loadedRotState.selectedMvps||{}, vipCounts:loadedRotState.vipCounts||{}, mvpCounts:loadedRotState.mvpCounts||{} }, previousRotationState:localPrev }; if(!state.rotationState.currentDate||isNaN(new Date(state.rotationState.currentDate+'T00:00:00Z'))){ console.warn("Loaded state missing/invalid date."); needsDateUpdate=true; } } else { console.log("No FS doc. Initial setup..."); needsInitialSetup=true; } if(needsInitialSetup||needsDateUpdate){ console.log(`Setup: Initial=${needsInitialSetup}, DateUpdate=${needsDateUpdate}`); const today=new Date(); const nextM=findNextMonday(today); const nextMStr=getISODateString(nextM); if(needsInitialSetup){ state={ members:initialMembers.map(m=>({...m})), rotationState:{currentDate:nextMStr, r4r5Index:0, memberIndex:0, skippedVips:[], selectedMvps:{}, vipCounts:{}, mvpCounts:{}}, previousRotationState:null }; console.log("Init state, date:", nextMStr); updateFirestoreState().catch(err=>console.error("Initial save FAIL:", err)); } else if(needsDateUpdate){ state.rotationState.currentDate=nextMStr; console.log("Updating date to:", nextMStr); updateFirestoreState().catch(err=>console.error("Date update save FAIL:", err)); } } console.log("Final local state:", JSON.parse(JSON.stringify(state))); render(); resetBtn.disabled=false; }, (error) => { console.error("FS Listener ERROR:", error); alert(`FATAL DB ERROR (${error.message}). Check connection, config, rules, console.`); document.getElementById('vip-actions').style.display='none'; document.getElementById('member-manager').style.pointerEvents='none'; document.getElementById('member-manager').style.opacity='0.5'; currentDateEl.textContent="DB Error"; resetBtn.disabled=true; undoAdvanceBtn.disabled=true; });
        // --- Initial Theme Render ---
        (() => { const theme=localStorage.getItem('theme'); if(theme==='dark'){ document.body.classList.add('dark-mode'); themeToggleBtn.textContent="Toggle Light Mode"; } else { document.body.classList.remove('dark-mode'); themeToggleBtn.textContent="Toggle Dark Mode"; } })();
    </script>
</body>
</html>
